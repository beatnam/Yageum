<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>결제 수단 추가</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Gowun+Dodum&display=swap"
		rel="stylesheet">
	<link rel="stylesheet" href="../css/my_page.css">
	<link rel="stylesheet" href="../css/my_page_method_insert.css">
</head>

<body>
	<!-- 헤더 -->
	<div th:replace="fragments/header :: header"></div>

	<div class="accountbook-container">
		<div th:replace="fragments/m_sidebar :: m_sidebar"></div>

		<main class="accountbook-main-content">
			<h1>내 카드 추가</h1>
			
			<div class="card-form-container">
				<form id="cardAddForm" action="/mypage/minsertPro" method="post" onsubmit="return validateForm()">
				    <!-- 카드번호 -->
				    <div class="form-group">
				        <label class="form-label required">카드번호</label>
				        <div class="card-number-group">
				            <input type="text" class="form-input card-number-input" id="card1" name="card1" maxlength="4" placeholder="1234">
				            <input type="text" class="form-input card-number-input masked" id="card2" name="card2" maxlength="4" placeholder="••••">
				            <input type="text" class="form-input card-number-input masked" id="card3" name="card3" maxlength="4" placeholder="••••">
				            <input type="text" class="form-input card-number-input" id="card4" name="card4" maxlength="4" placeholder="1234">
				        </div>
				        <div class="error-message" id="cardNumberError"></div>
				    </div>

				    <!-- 유효기간 -->
				    <div class="form-group">
				        <label class="form-label required">유효기간</label>
				        <div class="expiry-group">
				            <input type="text" class="form-input expiry-input" id="expiryMM" name="expiryMM" maxlength="2" placeholder="MM">
				            <span class="expiry-slash">/</span>
				            <input type="text" class="form-input expiry-input" id="expiryYY" name="expiryYY" maxlength="2" placeholder="YY">
				        </div>
				        <div class="error-message" id="expiryError"></div>
				    </div>

				    <!-- 소유자명 -->
				    <div class="form-group">
				        <label class="form-label required">소유자명</label>
				        <input type="text" class="form-input" id="cardHolder" name="cardHolder" placeholder="카드 소유자 이름을 입력하세요">
				        <div class="error-message" id="cardHolderError"></div>
				    </div>

				    <!-- 보안코드(CVC) -->
				    <div class="form-group">
				        <label class="form-label required">보안코드(CVC)</label>
				        <div class="cvc-group">
				            <input type="text" class="form-input cvc-input" id="cvc" name="cvc" maxlength="3" placeholder="•••">
				            <span class="cvc-hint">* 3글자만 입력하세요</span>
				        </div>
				        <div class="error-message" id="cvcError"></div>
				    </div>

				    <!-- 카드회사 선택 -->
				    <div class="form-group">
				        <label class="form-label required">카드회사</label>
				        <select id="cardCorporation" name="cardCorporation" class="form-input">
				            <option value="">카드사를 선택하세요</option>
				            <option th:each="company : ${companyList}"
				                    th:value="${company.ccIn}"
				                    th:text="${company.ccName}">
				            </option>
				        </select>
				        <div class="error-message" id="cardCorporationError"></div>
				    </div>

				    <!-- 카드 유형 선택 -->
				    <div class="form-group">
				        <label class="form-label required">카드 유형</label>
				        <select id="cardType" name="cardType" class="form-input">
				            <option value="">카드 유형을 선택하세요</option>
				            <option value="1">신용카드</option>
				            <option value="2">체크카드</option>
				        </select>
				        <div class="error-message" id="cardTypeError"></div>
				    </div>

				    <!-- 카드이름 -->
				    <div class="form-group">
				        <label class="form-label required">카드이름</label>
				        <input type="text" class="form-input" id="cardName" name="cardName" placeholder="예: 삼성카드, 신한카드 등">
				        <div class="error-message" id="cardNameError"></div>
				    </div>

				    <!-- CSRF 토큰 -->
				    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

				    <!-- 저장 버튼 -->
				    <button type="submit" class="save-button">저장하기</button>
				</form>
			</div>
		</main>
	</div>

	<!-- 푸터 -->
	<div th:replace="fragments/footer :: footer"></div>

	<script>
	  // 카드번호 자동 이동
	  const cardInputs = document.querySelectorAll('.card-number-input');
	  cardInputs.forEach((input, index) => {
	    input.addEventListener('input', function () {
	      this.value = this.value.replace(/[^0-9]/g, '');
	      if (this.value.length === 4 && index < cardInputs.length - 1) {
	        cardInputs[index + 1].focus();
	      }
	    });
	    input.addEventListener('keydown', function (e) {
	      if (e.key === 'Backspace' && this.value.length === 0 && index > 0) {
	        cardInputs[index - 1].focus();
	      }
	    });
	  });

	  // 유효기간 입력 자동 이동
	  const expiryInputs = document.querySelectorAll('.expiry-input');
	  expiryInputs.forEach((input, index) => {
	    input.addEventListener('input', function () {
	      this.value = this.value.replace(/[^0-9]/g, '');
	      if (this.value.length === 2 && index === 0) {
	        expiryInputs[1].focus();
	      }
	    });
	    input.addEventListener('keydown', function (e) {
	      if (e.key === 'Backspace' && this.value.length === 0 && index === 1) {
	        expiryInputs[0].focus();
	      }
	    });
	  });

	  // CVC 숫자만 입력
	  document.getElementById('cvc').addEventListener('input', function () {
	    this.value = this.value.replace(/[^0-9]/g, '');
	  });

	  // 폼 유효성 검사 함수
	  function validateForm() {
	    let isValid = true;

	    const expiryMM = document.querySelector('input[name="expiryMM"]');
	    const expiryYY = document.querySelector('input[name="expiryYY"]');
	    const cardHolder = document.querySelector('input[name="cardHolder"]');
	    const cvc = document.querySelector('input[name="cvc"]');
	    const cardType = document.querySelector('select[name="cardType"]');
	    const cardName = document.querySelector('input[name="cardName"]');
	    const cardInputs = document.querySelectorAll('.card-number-input');

	    const cardNumber = Array.from(cardInputs).map(input => input.value).join('');
	    if (cardNumber.length !== 16) {
	      showError('cardNumberError', '카드번호 16자리를 모두 입력해주세요.');
	      isValid = false;
	    } else {
	      hideError('cardNumberError');
	    }

	    if (!expiryMM.value || !expiryYY.value || expiryMM.value < 1 || expiryMM.value > 12) {
	      showError('expiryError', '올바른 유효기간을 입력해주세요.');
	      isValid = false;
	    } else {
	      hideError('expiryError');
	    }

	    if (!cardHolder.value.trim()) {
	      showError('cardHolderError', '소유자명을 입력해주세요.');
	      isValid = false;
	    } else {
	      hideError('cardHolderError');
	    }

	    if (cvc.value.length !== 3) {
	      showError('cvcError', 'CVC 3자리를 입력해주세요.');
	      isValid = false;
	    } else {
	      hideError('cvcError');
	    }

	    if (!cardType.value) {
	      showError('cardTypeError', '카드 유형을 선택해주세요.');
	      isValid = false;
	    } else {
	      hideError('cardTypeError');
	    }

	    if (!cardName.value.trim()) {
	      showError('cardNameError', '카드이름을 입력해주세요.');
	      isValid = false;
	    } else {
	      hideError('cardNameError');
	    }

	    return isValid;
	  }

	  // 에러 메시지 출력/제거 함수
	  function showError(id, message) {
	    document.getElementById(id).textContent = message;
	  }
	  function hideError(id) {
	    document.getElementById(id).textContent = '';
	  }
	  
	  const bankNameMap = {
		"Kb Kookmin Card Co., Ltd.": "27",
	      "KB Kookmin Card": "27",
	      "Kookmin Card": "27",
	      "Shinhan Card": "28",
	      "Samsung Card": "29",
	      "Hyundai Card": "30",
	      "Lotte Card": "31",
	      "Hana Card": "32",
	      "Woori Card": "33",
	      "NH Nonghyup Card": "34",
	      "Citi": "35",
	      "Citibank": "35",
	      "IBK": "36",
	      "SC First Bank": "37",
	      "SC Bank": "37",
	      "KakaoBank": "38",
	      "Toss Bank": "39",
	      "Suhyup Bank": "40",
	      "K Bank": "41"
	    };

	    const cardCorporationSelect = document.getElementById('cardCorporation');

	    cardInputs.forEach(input => {
	      input.addEventListener('input', async () => {
	        const fullNumber = Array.from(cardInputs).map(i => i.value).join('');
	        if (fullNumber.length >= 6) {
	          const bin = fullNumber.substring(0, 6);
	          try {
	            const res = await fetch(`/mypage/binlookup/${bin}`);
	            if (!res.ok) throw new Error("BIN 조회 실패");

	            const data = await res.json();
	            const bankName = data.bank?.name;
	            console.log("조회된 카드사명:", bankName);

	            const matchedValue = bankNameMap[bankName];
	            if (matchedValue) {
	              cardCorporationSelect.value = matchedValue;
	              console.log("자동 선택된 cc_in 값:", matchedValue);
	            } else {
	              console.warn("매칭 실패:", bankName);
	            }
	          } catch (e) {
	            console.error("BIN API 오류:", e);
	          }
	        }
	      });
	    });
	    

	    // DOM 로드 후 실행
	    //document.addEventListener('DOMContentLoaded', autoDetectcardCorporation);
	</script>
	</script>
</body>

</html>