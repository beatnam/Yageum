<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta name="_csrf" th:content="${_csrf.token}"/>
	<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤í”ˆë±…í‚¹ ì—°ê²°</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Gowun+Dodum&display=swap"
		rel="stylesheet">
    <link rel="stylesheet" href="/css/my_page.css">
    <link rel="stylesheet" href="/css/my_page_openbanking.css">
</head>

<body>
    <!-- í—¤ë” -->
    <div th:replace="fragments/header :: header"></div>

    <div class="accountbook-container">
		
        <!-- ë§ˆì´í˜ì´ì§€ ì‚¬ì´ë“œë°” -->
        <div th:replace="fragments/m_sidebar :: m_sidebar"></div>

        <!-- ë³¸ë¬¸ -->
        <main class="accountbook-main-content">
			<div class="edit-header">
				<h1>ì˜¤í”ˆë±…í‚¹ ê³„ì¢Œ ì—°ê²°</h1>
				<p>ì˜¤í”ˆë±…í‚¹ ì¸ì¦ì„ í†µí•´ ë‚´ ê³„ì¢Œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
			</div>

            <button type="button" onclick="openAuthPopup()">ğŸ” ì˜¤í”ˆë±…í‚¹ ì¸ì¦</button>
            <br><br>
            <button type="button" onclick="loadAccounts()">ğŸ“‚ ê³„ì¢Œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°</button>

            <!-- ê³„ì¢Œ ëª©ë¡ ì¶œë ¥ ì˜ˆì • -->
            <div id="account-list">
                <!-- JS or Thymeleafë¡œ ê³„ì¢Œ ëª©ë¡ ì¶œë ¥ ì˜ˆì • -->
            </div>
			
			<!-- ê³„ì¢Œ ì €ì¥ ë²„íŠ¼ -->
			<div style="text-align: center; margin-top: 20px;">
			    <button type="button" onclick="saveAccounts()">ğŸ’¾ ê³„ì¢Œ ì €ì¥</button>
			</div>
        </main>
    </div>
	<script>
		
		let accountList = [];
		
		function loadAccounts() {
		    fetchAccountsWithToken();
		}
	
	function openAuthPopup() {
	    const popup = window.open(
	        '/openbanking/mock-auth',
	        'openbankingAuth',
	        'width=500,height=500,top=100,left=100'
	    );

	    // íŒì—…ì´ ë‹«íˆë©´ ìë™ ìƒˆë¡œê³ ì¹¨
	    const timer = setInterval(() => {
	        if (popup.closed) {
	            clearInterval(timer);
	            location.reload(); // ì¸ì¦ í† í° í™•ì¸ ìœ„í•´ ìƒˆë¡œê³ ì¹¨
	        }
	    }, 500);
	}
	
	function fetchAccountsWithToken() {
	    const token = sessionStorage.getItem('access_token');

	    fetch(`/openbanking/fetchAccounts?access_token=${token}`)
	        .then(res => res.json())
	        .then(data => {
	            const listDiv = document.getElementById("account-list");
	            listDiv.innerHTML = "";

	            if (data.error) {
	                listDiv.innerHTML = `<p style="color:red;">${data.error}</p>`;
	                return;
	            }
				
				accountList = data.res_list; 

	            const title = document.createElement("h3");
	            title.innerText = `${data.user_name}ë‹˜ì˜ ê³„ì¢Œ ëª©ë¡`;
	            listDiv.appendChild(title);

	            data.res_list.forEach(acc => {
	                const div = document.createElement("div");
	                div.innerText = `ğŸ¦ ${acc.bank_name} / ${acc.account_num_masked}`;
	                listDiv.appendChild(div);
	            });
	        });
	}
	
	window.addEventListener('message', function(event) {
	    if (event.data.type === 'MOCK_AUTH_SUCCESS') {
	        alert("ëª¨ì˜ ì¸ì¦ ì™„ë£Œ! ê³„ì¢Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.");
	        fetchAccountsWithToken();  
	    }
	});
	
	function saveAccounts() {
	    const token = document.querySelector('meta[name="_csrf"]').getAttribute("content");
	    const header = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

	    fetch("/openbanking/saveAccounts", {
	        method: "POST",
	        headers: {
	            "Content-Type": "application/json",
	            [header]: token  // CSRF í† í° í¬í•¨
	        },
	        body: JSON.stringify(accountList),
	        credentials: "include"
	    })
	    .then(res => res.text())
	    .then(msg => alert(msg));
	}
	</script>
	
</body>


</html>