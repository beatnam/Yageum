<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>야금야금 - 오픈뱅킹 가계부</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Nanum+Brush+Script&family=Black+Han+Sans&display=swap" rel="stylesheet">

 <link rel="stylesheet" href="../css/common.css">
 <link rel="stylesheet" href="../css/cashbook_main.css">

</head>
<body>
	<!-- 헤더 -->
		<div th:replace="~{fragments/header :: header}"></div>
		
    <!-- 사이드바 + 본문 -->
    <div class="app-container">
      		<div th:replace="fragments/sidebar :: sidebar"></div>

           <main class="content">
            <div class="content-header">
                 <h2>나의 가계부 캘린더</h2>
                <p>이번 달 수입 / 지출을 확인하세요!</p>
            </div>
            <div class="content-body">
                <div class="calendar-container">
                    <!-- 달력 상단 헤더 -->
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button class="nav-btn" onclick="changeMonth(-1)">◀</button>
                            <span class="current-month" id="currentMonth">2025년 6월</span>
                            <button class="nav-btn" onclick="changeMonth(1)">▶</button>
                        </div>
                        <div class="monthly-summary">
                            <div class="summary-item">
                                <div class="summary-label">총 수입</div>
                                <div class="summary-amount income" id="monthlyIncome">+2,500,000원</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">총 지출</div>
                                <div class="summary-amount expense" id="monthlyExpense">-1,850,000원</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">현재 금액</div>
                                <div class="summary-amount balance" id="monthlyBalance">+650,000원</div>
                            </div>
                        </div>
                    </div>

                    <!-- 달력 테이블 -->
                    <table class="calendar-table">
                        <thead>
                            <tr>
                                <th>일</th>
                                <th>월</th>
                                <th>화</th>
                                <th>수</th>
                                <th>목</th>
                                <th>금</th>
                                <th>토</th>
                            </tr>
                        </thead>
                        <tbody id="calendarBody">
                            <!-- 달력 내용이 여기에 동적으로 생성됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

	<!--	푸터-->
		<div th:replace="fragments/footer :: footer"></div>

    <script>
             // 현재 표시중인 년도와 월
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth(); // 0부터 시작 (0 = 1월)

        // 샘플 거래 데이터 (실제로는 서버에서 받아올 데이터)
        const sampleTransactions = {
            '2025-6-1': { income: 0, expense: 15000 },
            '2025-6-3': { income: 50000, expense: 0 },
            '2025-6-5': { income: 32000, expense: 25000 },
            '2025-6-7': { income: 0, expense: 8000 },
            '2025-6-10': { income: 2500000, expense: 0 },
            '2025-6-12': { income: 0, expense: 45000 },
            '2025-6-15': { income: 0, expense: 120000 },
            '2025-6-18': { income: 0, expense: 30000 },
            '2025-6-20': { income: 0, expense: 67000 },
            '2025-6-22': { income: 0, expense: 15000 },
            '2025-6-25': { income: 0, expense: 89000 },
            '2025-6-28': { income: 0, expense: 42000 }
        };

        // 달력 생성 함수
        function generateCalendar(year, month) {
            const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', 
                              '7월', '8월', '9월', '10월', '11월', '12월'];
            
            // 월 표시 업데이트
            document.getElementById('currentMonth').textContent = `${year}년 ${monthNames[month]}`;
            
            // 첫 번째 날과 마지막 날 계산
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';
            
            const today = new Date();
            
            // 6주 생성
            for (let week = 0; week < 6; week++) {
                const row = document.createElement('tr');
                
                for (let day = 0; day < 7; day++) {
                    const cell = document.createElement('td');
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + (week * 7) + day);
                    
                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'date-number';
                    dateDiv.textContent = currentDate.getDate();
                    
                    // 다른 달의 날짜 스타일 적용
                    if (currentDate.getMonth() !== month) {
                        dateDiv.classList.add('other-month');
                    }
                    
                    // 오늘 날짜 표시
                    if (currentDate.toDateString() === today.toDateString()) {
                        dateDiv.classList.add('today');
                    }
					
					// 날짜 공간 클릭하면 리스트 페이지로 이동
					cell.addEventListener('click', () => {
					    const y = currentDate.getFullYear();
					    const m = (currentDate.getMonth() + 1).toString().padStart(2, '0');
					    const d = currentDate.getDate().toString().padStart(2, '0');
					    const dateStr = `${y}-${m}-${d}`;
					    
						// 현재 월의 날짜만 이동 가능
						   if (currentDate.getMonth() === month) {
						       window.location.href = `/cashbook/list?date=${dateStr}`;
						   }
					});
                    
                    cell.appendChild(dateDiv);
                    
                    // 거래 내역 표시 (현재 월의 날짜만)
                    if (currentDate.getMonth() === month) {
                        const dateKey = `${year}-${month + 1}-${currentDate.getDate()}`;
                        const transactions = sampleTransactions[dateKey];
                        
                        if (transactions) {
                            const transactionDiv = document.createElement('div');
                            transactionDiv.className = 'date-transactions';
                            
                            if (transactions.income > 0) {
                                const incomeDiv = document.createElement('div');
                                incomeDiv.className = 'transaction-item transaction-income';
                                incomeDiv.textContent = `+${transactions.income.toLocaleString()}`;
                                transactionDiv.appendChild(incomeDiv);
                            }
                            
                            if (transactions.expense > 0) {
                                const expenseDiv = document.createElement('div');
                                expenseDiv.className = 'transaction-item transaction-expense';
                                expenseDiv.textContent = `-${transactions.expense.toLocaleString()}`;
                                transactionDiv.appendChild(expenseDiv);
                            }
                            
                            cell.appendChild(transactionDiv);
                        }
                    }
                    
                    row.appendChild(cell);
                }
                
                calendarBody.appendChild(row);
            }
            
            // 월별 요약 업데이트
            updateMonthlySummary(year, month);
        }

        // 월별 요약 업데이트 함수
        function updateMonthlySummary(year, month) {
            let totalIncome = 0;
            let totalExpense = 0;
            
            // 해당 월의 모든 거래 합계 계산
            Object.keys(sampleTransactions).forEach(key => {
                const [transYear, transMonth] = key.split('-').map(Number);
                if (transYear === year && transMonth === month + 1) {
                    const transaction = sampleTransactions[key];
                    totalIncome += transaction.income;
                    totalExpense += transaction.expense;
                }
            });
            
            const balance = totalIncome - totalExpense;
            
            document.getElementById('monthlyIncome').textContent = 
                totalIncome > 0 ? `+${totalIncome.toLocaleString()}원` : '0원';
            document.getElementById('monthlyExpense').textContent = 
                totalExpense > 0 ? `-${totalExpense.toLocaleString()}원` : '0원';
            document.getElementById('monthlyBalance').textContent = 
                `${balance >= 0 ? '+' : ''}${balance.toLocaleString()}원`;
        }

        // 월 변경 함수
        function changeMonth(direction) {
            currentMonth += direction;
            
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            
            generateCalendar(currentYear, currentMonth);
        }

      

        function logout() {
            if(confirm('로그아웃 하시겠습니까?')) {
                window.location.href = '/logout';
            }
        }

         // 페이지 로드 시 현재 월 달력 생성
        document.addEventListener('DOMContentLoaded', function() {
            generateCalendar(currentYear, currentMonth);
        });
    </script>
</body>
</html>