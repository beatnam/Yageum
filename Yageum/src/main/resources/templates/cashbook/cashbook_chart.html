<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
	<title>야금야금 - 나의 차트</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Google Fonts -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link
		href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Nanum+Brush+Script&family=Black+Han+Sans&display=swap"
		rel="stylesheet">

	<link rel="stylesheet" href="../css/common.css">
	<link rel="stylesheet" href="../css/cashbook_chart.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

	<style>

	</style>
</head>

<body>
	<!-- 헤더 -->
	<div th:replace="fragments/header :: header"></div>

	<!-- 사이드바 + 본문 -->
	<div class="app-container">
		<div th:replace="fragments/sidebar :: sidebar"></div>

		<main class="content">
			<div class="content-header">
				<h2>나의 차트</h2>
				<p>가계부 내역을 시각적으로 확인해보세요</p>
			</div>

			<div class="content-body">
				<!-- 차트 헤더 -->
				<div class="chart-header">
					<div class="chart-title">월별 차트</div>
					<div class="date-navigator">
						<button class="nav-arrow" onclick="previousMonth()">◀</button>
						<div class="current-date" onclick="openDateModal()">2025년 06월</div>
						<button class="nav-arrow" onclick="nextMonth()">▶</button>
					</div>
				</div>

				<!-- 총계 요약 -->
				<div class="total-summary">
					<div class="summary-item">
						<div class="summary-label">총 수입</div>
						<div class="summary-amount income">+ <span
								th:text="${plus != null and plus['plus'] != null ? #numbers.formatDecimal(plus['plus'], 0, 'COMMA', 0, 'POINT') : '0'}"
								class="summary-amount income"></span>원</div>
					</div>
					<div class="summary-item">
						<div class="summary-label">총 지출</div>
						<div class="summary-amount expense">-<span
								th:text="${minus != null and minus['minus'] != null ? #numbers.formatDecimal(minus['minus'], 0, 'COMMA', 0, 'POINT') : '0'}"
								class="summary-amount expense"></span>원</div>
					</div>
					<div class="summary-item">
						<div class="summary-label">잔액</div>
						<div class="summary-amount balance">
							<span th:text="${#numbers.formatDecimal(sum, 0, 'COMMA', 0, 'POINT')}" class="summary-amount balance"></span> 원
						</div>
					</div>
				</div>

				<!-- 차트 컨테이너 -->
				<div class="charts-container">
					<div class="chart-box">
						<h3>카테고리별 지출 (원형 차트)</h3>
						<div class="chart-canvas">
							<canvas id="pieChart"></canvas>
						</div>
					</div>
					<div class="chart-box">
						<h3>일별 수입/지출 현황 (막대 차트)</h3>
						<div class="chart-canvas">
							<canvas id="barChart"></canvas>
						</div>
					</div>
				</div>

				<!-- 지출 내역 상세 -->
				<div class="expense-table">
					<div class="table-header">
						카테고리별 지출 내역
					</div>
					<div class="expense-list">
						<div class="expense-item" th:each="item, iterStat : ${sumExpense}">
							<div class="expense-category">
								<div class="category-dot"
									th:style="'background-color:' + (${colors[iterStat.index % colors.size()]})">
								</div>
								<span th:text="${item.cm_name}">카테고리명</span>
							</div>
							<div class="expense-amount"
								th:text="${#numbers.formatDecimal(item.expenseSum, 0, 'COMMA', 0, 'POINT')} + '원'">
								금액
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>
	</div>

	<!-- 날짜 선택 모달 -->
	<div id="dateModal" class="date-modal">
		<div class="date-modal-content">
			<div class="modal-header">날짜 선택</div>
			<div class="date-selectors">
				<div class="date-selector">
					<label>년도</label>
					<select id="yearSelect">
						<option value="2023">2023년</option>
						<option value="2024">2024년</option>
						<option value="2025" selected>2025년</option>
						<option value="2026">2026년</option>
					</select>
				</div>
				<div class="date-selector">
					<label>월</label>
					<select id="monthSelect">
						<option value="1">1월</option>
						<option value="2">2월</option>
						<option value="3">3월</option>
						<option value="4">4월</option>
						<option value="5">5월</option>
						<option value="6" selected>6월</option>
						<option value="7">7월</option>
						<option value="8">8월</option>
						<option value="9">9월</option>
						<option value="10">10월</option>
						<option value="11">11월</option>
						<option value="12">12월</option>
					</select>
				</div>
			</div>
			<div class="modal-buttons">
				<button class="modal-btn btn-confirm" onclick="confirmDateChange()">확인</button>
				<button class="modal-btn btn-cancel" onclick="closeDateModal()">취소</button>
			</div>
		</div>
	</div>

	<!--	푸터-->
	<div th:replace="fragments/footer :: footer"></div>

	<script th:inline="javascript">
		// 서버에서 넘어온 값으로 초기화
		let currentYear = /*[[${year}]]*/ 2025;
		let currentMonth = /*[[${month}]]*/ 6;

		// sumExpense : List<Map<String,Object>> 형태로 넘어왔다고 가정
		const pieChartData = /*[[${sumExpense}]]*/[];
	</script>

	<script>
		let pieChart, barChart;

		document.addEventListener('DOMContentLoaded', function () {
			updateDateDisplay();
			initializeCharts();
		});

		function initializeCharts() {
			initPieChart();
			initBarChart();
		}

		// 원형 차트 초기화
		function initPieChart() {
			const ctx = document.getElementById('pieChart').getContext('2d');

			if (pieChart) {
				pieChart.destroy();
			}

			let labels = [];
			let data = [];
			if (Array.isArray(pieChartData) && pieChartData.length > 0) {
				labels = pieChartData.map(item => item.cm_name);
				data = pieChartData.map(item => item.expenseSum);
			} else {
				// 기본값 처리 (필요시)
			}

			pieChart = new Chart(ctx, {
				type: 'pie',
				data: {
					labels: labels,
					datasets: [{
						data: data,
						backgroundColor: [
							'#FF6B6B', '#4ECDC4', '#45B7D1', '#F9CA24', '#6C5CE7',
							'#A29BFE', '#FD79A8', '#00B894', '#E17055'
						],
						borderWidth: 2,
						borderColor: '#fff'
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						legend: {
							position: 'bottom',
							labels: {
								padding: 20,
								usePointStyle: true,
								font: {family: 'Gowun Dodum'}
							}
						},
						tooltip: {
							callbacks: {
								label: function (context) {
									return context.label + ': ' + context.parsed.toLocaleString() + '원';
								}
							}
						}
					}
				}
			});
		}

		// 막대 차트 초기화 (기존 코드 유지)
		function initBarChart() {
			// ...기존 initBarChart 함수 내용 그대로 사용...
		}

		// 이전 달로 이동
		function previousMonth() {
			if (currentMonth === 1) {
				currentMonth = 12;
				currentYear--;
			} else {
				currentMonth--;
			}
			updateDateDisplay();
			loadMonthData();
		}

		// 다음 달로 이동
		function nextMonth() {
			if (currentMonth === 12) {
				currentMonth = 1;
				currentYear++;
			} else {
				currentMonth++;
			}
			updateDateDisplay();
			loadMonthData();
		}

		// 날짜 표시 업데이트
		function updateDateDisplay() {
			const dateElement = document.querySelector('.current-date');
			dateElement.textContent = `${currentYear}년 ${currentMonth.toString().padStart(2, '0')}월`;
		}

		// 월별 데이터 로드 (서버 연동 시 AJAX 호출 가능)
		function loadMonthData() {
			console.log(`Loading data for ${currentYear}-${currentMonth}`);
			initializeCharts();
		}

		// 모달 외부 클릭 시 닫기
		document.getElementById('dateModal').addEventListener('click', function (e) {
			if (e.target === this) {
				closeDateModal();
			}
		});

		// 날짜 선택 모달 관련 함수
		function openDateModal() {
			document.getElementById('yearSelect').value = currentYear;
			document.getElementById('monthSelect').value = currentMonth;
			document.getElementById('dateModal').style.display = 'block';
		}

		function closeDateModal() {
			document.getElementById('dateModal').style.display = 'none';
		}

		function confirmDateChange() {
			const newYear = parseInt(document.getElementById('yearSelect').value);
			const newMonth = parseInt(document.getElementById('monthSelect').value);

			currentYear = newYear;
			currentMonth = newMonth;

			updateDateDisplay();
			loadMonthData();
			closeDateModal();
		}

		// 로그아웃 함수
		function logout() {
			if (confirm('로그아웃 하시겠습니까?')) {
				window.location.href = '/logout';
			}
		}
	</script>

</body>

</html>