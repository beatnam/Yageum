<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>ê°€ê³„ë¶€ ì…ë ¥</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Nanum+Brush+Script&family=Black+Han+Sans&display=swap" rel="stylesheet">

 <link rel="stylesheet" href="../css/common.css">
 <link rel="stylesheet" href="../css/cashbook_insert.css">

</head>
<body>
	<!-- í—¤ë” -->
	<div th:replace="fragments/header :: header"></div>


    <!-- ì‚¬ì´ë“œë°” + ë³¸ë¬¸ -->
    <div class="app-container">
       		<div th:replace="fragments/sidebar :: sidebar"></div>

            <main class="content">
            <div class="content-header">
                <h2>ë‚´ì—­ ìˆ˜ì •</h2>
                <p>ìˆ˜ì •í•  ë‚´ì—­ì„ ì…ë ¥í•˜ì„¸ìš”!</p>
            </div>
            <div class="content-body">
              <div class="form-container">
        <form id="transactionForm" action="/cashbook/updatePro" method="post" onsubmit="return handleSubmit(event)">
			<!-- ë‚ ì§œ ì…ë ¥ -->
			<div class="form-group">
			    <label class="form-label">ë‚ ì§œ <span class="required">*</span></label>
			    <input type="date" class="form-input" id="expenseDate" name="expenseDate"
			           th:value="${expense.expenseDate}" required>
			</div>
			
            <!-- ê¸ˆì•¡ ì…ë ¥ -->
            <div class="form-group">
                <label class="form-label">ê¸ˆì•¡ <span class="required">*</span></label>
                <input type="text" class="amount-input" id="expenseSum" name="expenseSum" placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”"
				th:value="${#numbers.formatInteger(expense.expenseSum, 3, 'COMMA')}" required>
                <div class="error-message">ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
            </div>

            <!-- ìœ í˜• ì„ íƒ -->
            <div class="form-group">
                <label class="form-label">ìœ í˜• <span class="required">*</span></label>
                <div class="type-buttons">
                    <button type="button" class="type-btn income" onclick="selectType('income')">ìˆ˜ì…</button>
                    <button type="button" class="type-btn expense" onclick="selectType('expense')">ì§€ì¶œ</button>
                </div>
                <input type="hidden" id="expenseType" name="expenseType" th:value="${expense.expenseType ? 1 : 0}" required>
                <div class="error-message">ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
            </div>

            <!-- ë‚´ìš© ì…ë ¥ -->
            <div class="form-group">
                <label class="form-label">ë‚´ìš© <span class="required">*</span></label>
                <input type="text" class="form-input" id="expenseContent" name="expenseContent" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" 
				th:value="${expense.expenseContent}" required>
                <div class="error-message">ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
            </div>

            <!-- ìˆ˜ë‹¨ ì„ íƒ -->
            <div class="form-group">
                <label class="form-label">ìˆ˜ë‹¨ <span class="required">*</span></label>
                <div class="select-group">
					<select class="form-select" id="method1" name="method_in" onchange="updateMethod2()" required>
					    <option value="">ì„ íƒ</option>
					    <option value="1" th:selected="${expense.methodIn == 1}">ì‹ ìš©ì¹´ë“œ</option>
					    <option value="2" th:selected="${expense.methodIn == 2}">ì²´í¬ì¹´ë“œ</option>
					    <option value="3" th:selected="${expense.methodIn == 3}">í˜„ê¸ˆ</option>
					    <option value="4" th:selected="${expense.methodIn == 4}">ê³„ì¢Œ</option>
					</select>
					<input type="hidden" id="cardIn" th:value="${expense.cardIn}"/>
					<input type="hidden" id="accountIn" th:value="${expense.accountIn}"/>
                    <select class="form-select" id="method2" name="method2" disabled required>
                        <option value="">ìƒì„¸ ì„ íƒ</option>
                    </select>
                </div>
                <div class="error-message">ìˆ˜ë‹¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
            </div>

			<!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
			<div class="form-group">
			  <label class="form-label">ì¹´í…Œê³ ë¦¬ <span class="required">*</span></label>
			  <div class="category-selector">
			    <div class="category-display" id="categoryDisplay">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
			    <button type="button" class="category-btn" onclick="openCategoryModal()">ì„ íƒ</button>
			    <input type="hidden" id="cs_in" name="cs_in" required>
			  </div>
			</div>

			<!-- ì¹´í…Œê³ ë¦¬ ëª¨ë‹¬ -->
			<div id="categoryModal" class="modal-overlay" style="display: none;">
			  <div class="modal-content">
			    <h3 class="modal-title">ì¹´í…Œê³ ë¦¬ ì„ íƒ</h3>
			    <div class="category-modal-body">
			      <ul class="category-list" id="mainCategoryList">
			        <!-- ëŒ€ë¶„ë¥˜ ë¦¬ìŠ¤íŠ¸ ë™ì  ìƒì„± -->
					<li th:each="main : ${mainList}" th:text="${main.cmName}" th:attr="data-cmin=${main.cmIn}" onclick="loadSubCategories(this)">
						[[${main.cmName}]]
					</li>
			      </ul>
			      <ul class="subcategory-list" id="subCategoryList">
			        <!-- ì—¬ê¸°ì— ì†Œë¶„ë¥˜ê°€ ë™ì ìœ¼ë¡œ ëœ¸ -->
			      </ul>
			    </div>
			    <button onclick="closeCategoryModal()">ë‹«ê¸°</button>
			  </div>
			</div>

            <!-- ë©”ëª¨ ì…ë ¥ -->
            <div class="form-group">
                <label class="form-label">ë©”ëª¨</label>
                <textarea class="form-textarea" id="expenseMemo" name="expenseMemo" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”(ì„ íƒì‚¬í•­)"
				th:text="${expense.expenseMemo}"></textarea>
            </div>

            <!-- ì œì¶œ ë²„íŠ¼ -->
			<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" class="submit-btn">ìˆ˜ì •í•˜ê¸°</button>
        </form>
    </div>
            </div>
        </main>
    </div>

	<!-- í‘¸í„° -->
		<div th:replace="fragments/footer :: footer"></div>

    <script>
		console.log("âœ… í˜ì´ì§€ ë¡œë”©ë¨!");
		// í˜ì´ì§€ ë¡œë“œë˜ìë§ˆì ê¸°ì¡´ expenseType ê°’ì— ë”°ë¼ ë²„íŠ¼ ìƒ‰ìƒ ì§€ì •
		document.addEventListener("DOMContentLoaded", () => {
		    const expenseType = document.getElementById("expenseType").value;

		    const incomeBtn = document.querySelector(".type-btn.income");
		    const expenseBtn = document.querySelector(".type-btn.expense");

		    if (expenseType === "0") {
		        incomeBtn.classList.add("active");
		    } else if (expenseType === "1") {
		        expenseBtn.classList.add("active");
		    }
		});
		
		// ìœ í˜• ìˆ˜ì •
		function selectType(type) {
		    const incomeBtn = document.querySelector(".type-btn.income");
		    const expenseBtn = document.querySelector(".type-btn.expense");
		    const expenseTypeInput = document.getElementById("expenseType");

		    if (type === 'income') {
		        incomeBtn.classList.add("active");
		        expenseBtn.classList.remove("active");
		        expenseTypeInput.value = 0;
		    } else if (type === 'expense') {
		        incomeBtn.classList.remove("active");
		        expenseBtn.classList.add("active");
		        expenseTypeInput.value = 1;
		    }
		}
		
		//ìˆ˜ë‹¨ ê´€ë ¨
		document.addEventListener("DOMContentLoaded", function () {
		    const method1 = document.getElementById("method1").value;
			console.log("ğŸ¯ method1 ê°’:", method1);
		    const method2 = document.getElementById("method2");
		    const selectedCardIn = document.getElementById("cardIn").value;
		    const selectedAccountIn = document.getElementById("accountIn").value;

		    if (method1 === "1" || method1 === "2") {
		        fetch(`/cashbook/cards/byMethod/${method1}`)
		            .then(res => res.json())
		            .then(data => {
						console.log("ğŸ“¦ ì¹´ë“œ ë°ì´í„°:", data);
						console.log("ğŸ¯ ì„ íƒëœ ì¹´ë“œ ID:", selectedCardIn);
						
		                data.forEach(card => {
		                    const option = document.createElement("option");
		                    option.value = card.cardIn;
		                    option.textContent = card.cardName;
		                    if (String(card.cardIn) === selectedCardIn) {
		                        option.selected = true;
		                    }
		                    method2.appendChild(option);
		                });
		                method2.disabled = false;
		            });
		    } else if (method1 === "4") {
		        fetch(`/cashbook/accounts`)
		            .then(res => res.json())
		            .then(data => {
						console.log("ğŸ¦ ê³„ì¢Œ ë°ì´í„°:", data);
						console.log("ğŸ¯ ì„ íƒëœ ê³„ì¢Œ ID:", selectedAccountIn);
						
		                data.forEach(account => {
		                    const option = document.createElement("option");
		                    option.value = account.accountIn;
		                    option.textContent = account.bankName + " " + account.accountNum;
							console.log("ê³„ì¢Œ option ID ë¹„êµ: ", account.accountIn, selectedAccountIn);
		                    if (String(account.accountIn) === selectedAccountIn) {
		                        option.selected = true;
		                    }
		                    method2.appendChild(option);
		                });
		                method2.disabled = false;
		            });
		    }
		});
		
		
		// ìˆ˜ë‹¨ method2 ë‚˜ì˜¤ê²Œí•¨
		function updateMethod2() {
		    const method1 = document.getElementById('method1').value;
		    const method2 = document.getElementById('method2');
		    const selectedCard = /*[[${expense.cardIn}]]*/ 0;
		    const selectedAccount = /*[[${expense.accountIn}]]*/ 0;

		    method2.innerHTML = '<option value="">ìƒì„¸ ì„ íƒ</option>';
		    method2.disabled = true;
		    method2.removeAttribute("required");

		    if (method1 === "1" || method1 === "2") {
		        fetch(`/cashbook/cards/byMethod/${method1}`)
		            .then(res => res.json())
		            .then(data => {
		                data.forEach(card => {
		                    const option = document.createElement("option");
		                    option.value = card.cardIn;
		                    option.textContent = card.cardName;
		                    if (card.cardIn === selectedCard) {
		                        option.selected = true;
		                    }
		                    method2.appendChild(option);
		                });
		                method2.disabled = false;
		            });
		    } else if (method1 === "4") {
		        fetch(`/cashbook/accounts`)
		            .then(res => res.json())
		            .then(data => {
		                data.forEach(account => {
		                    const option = document.createElement("option");
		                    option.value = account.accountIn;
		                    option.textContent = account.bankName + " " + account.accountNum;
		                    if (account.accountIn === selectedAccount) {
		                        option.selected = true;
		                    }
		                    method2.appendChild(option);
		                });
		                method2.disabled = false;
		            });
		    }
		}
		</script>
	

</body>
</html>