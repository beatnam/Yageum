<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ê³„ë¶€ ì†Œë¹„ë¶„ì„ ë° í”¼ë“œë°±</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
	<link rel="stylesheet" href="../css/e_analysis.css">
	<link rel="stylesheet" href="../css/common.css">
</head>
<body>
<div th:replace="fragments/header :: header"></div>
<div class="app-container">
	
	<div th:replace="fragments/c_sidebar :: c_sidebar"></div>
<input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">

    <div class="container">
	    <div class="stats-grid">
	        <div class="stat-card">
	            <div class="stat-icon">ğŸ’³</div>
	            <div class="stat-label">ì´ë²ˆë‹¬ ë‹¬ ì´ ì§€ì¶œ</div>
	            <div class="stat-value" id="totalExpense">
	                &#8361;<span th:text="${totalExpense != null ? #numbers.formatDecimal(totalExpense, 0, 'COMMA', 0, 'POINT') : 'ë°ì´í„° ì—†ìŒ'}">0</span>
	            </div>
	        </div>
	        <div class="stat-card">
	            <div class="stat-icon">ğŸ“Š</div>
	            <div class="stat-label">í•˜ë£¨ í‰ê·  ì§€ì¶œ</div>
	            <div class="stat-value" id="averageDailyExpense">
	                &#8361;<span th:text="${averageDailyExpense != null ? #numbers.formatDecimal(averageDailyExpense, 0, 'COMMA', 0, 'POINT') : 'ë°ì´í„° ì—†ìŒ'}">0</span>
	            </div>
	        </div>
	        <div class="stat-card">
	            <div class="stat-icon">â³</div>
	            <div class="stat-label">ë‚¨ì€ ì¼ìˆ˜</div>
	            <div class="stat-value" id="daysLeft" th:text="${daysLeft != null ? daysLeft + 'ì¼' : 'ë°ì´í„° ì—†ìŒ'}">0ì¼</div>
	        </div>
	        <div class="stat-card">
	            <div class="stat-icon">ğŸ’°</div>
	            <div class="stat-label">ë‚¨ì€ ì˜ˆì‚°</div>
	            <div class="stat-value" id="remainingBudget">
	                &#8361;<span th:text="${remainingBudget != null ? #numbers.formatDecimal(remainingBudget, 0, 'COMMA', 0, 'POINT') : 'ë°ì´í„° ì—†ìŒ'}">0</span>
	            </div>
	        </div>
	    </div>
	
	    <div class="chart-section">
	        <h2>ì›”ë³„ ì§€ì¶œ ì¶”ì´</h2>
	        <div class="chart-container">
	            <canvas id="monthlyExpenseChart"></canvas>
	        </div>
	    </div>

        <div class="feedback-section">
            <h2>ChatGPTì˜ ì†Œë¹„ í”¼ë“œë°±</h2>
            <div id="chatGptFeedbackArea">
                <p>í”¼ë“œë°±ì„ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...</p> </div>
        </div>
		<div class="savings-goal-section">
		    <h2>ğŸ“Š ì§€ë‚œë‹¬ ì ˆì•½ ëª©í‘œ</h2>
		
		    <div th:if="${savingsPlan != null and not #maps.isEmpty(savingsPlan)}" class="goal-details-card">
		        <div class="goal-item">
		            <span class="goal-label">ëª©í‘œ:</span>
		            <span class="goal-value" th:text="${savingsPlan['save_name'] ?: 'ë¯¸ì„¤ì •'}">ëª©í‘œëª…</span>
		        </div>
		        <div class="goal-item">
		            <span class="goal-label">ëª©í‘œ ê¸ˆì•¡:</span>
		            <span class="goal-value" th:text="${'â‚©' + #numbers.formatInteger(savingsPlan['save_amount'] ?: 0, 0, 'COMMA')}">â‚©0</span>
		        </div>
		        <div class="goal-item">
		            <span class="goal-label">ì‹œì‘ì¼:</span>
		            <span class="goal-value" th:text="${savingsPlan['save_created_date'] != null ? #temporals.format(savingsPlan['save_created_date'], 'yyyy-MM-dd') : 'ë°ì´í„° ì—†ìŒ'}">YYYY-MM-DD</span>
		        </div>
		        <div class="goal-item">
		            <span class="goal-label">ëª©í‘œ ë‹¬ì„±ì¼:</span>
		            <span class="goal-value" th:text="${savingsPlan['save_target_date'] != null ? #temporals.format(savingsPlan['save_target_date'], 'yyyy-MM-dd') : 'ë°ì´í„° ì—†ìŒ'}">YYYY-MM-DD</span>
		        </div>
		        <div class="goal-item">
		            <span class="goal-label">ì§€ë‚œë‹¬ ì €ì¶•ê°€ëŠ¥ ê¸ˆì•¡:</span>
		            <span class="goal-value" th:text="${previousMonthSavableAmount != null and previousMonthSavableAmount > 0 ? 'â‚©' + #numbers.formatInteger(previousMonthSavableAmount, 0, 'COMMA') : 'ì§€ë‚œ ë‹¬ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'}">â‚©0</span>
		        </div>
		
		        <div class="progress-bar-container" th:if="${previousMonthBudgetUsageProgress != null and previousMonthBudgetUsageProgress >= 0}">
				    <div class="progress-bar-label">ì˜ˆì‚° ì‚¬ìš©ë¥ :</div> <div class="progress-bar-bg">
				        <div class="progress-bar-fill"
				             th:style="'width:' + ${#numbers.formatDecimal(previousMonthBudgetUsageProgress, 0, 0)} + '%'">
				            <span th:text="${#numbers.formatDecimal(previousMonthBudgetUsageProgress, 0, 0)} + '%'">0%</span>
				        </div>
				    </div>
				</div>
		    </div>
		
		    <div class="savings-plan-section" th:if="${savingsPlan == null or #maps.isEmpty(savingsPlan)}">
		        <p>ì§€ë‚œë‹¬ì˜ ì ˆì•½ ëª©í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ì˜ˆì‚°ì„ ì„¤ì •í•˜ê±°ë‚˜ ì´ì „ ë°ì´í„°ë¥¼ í™•ì¸í•´ ë³´ì„¸ìš”!</p>
		        <button class="btn" onclick="move()">ìƒˆë¡œìš´ ì˜ˆì‚° ìƒì„±í•˜ê¸°</button>
		    </div>
		
		    <div class="savings-plan-section" th:if="${savingsPlan != null and not #maps.isEmpty(savingsPlan)}">
		        <p>ì„¤ì •ëœ ì ˆì•½ ëª©í‘œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…í•©ë¶„ì„ìœ¼ë¡œ í™•ì‹¤í•˜ê²Œ!</p>
		        <button class="btn" id="moveToCanalysisBtn">ì¢…í•©ë¶„ì„ í™”ë©´ìœ¼ë¡œ ê°€ê¸°</button>
		    </div>
		</div>
	</div>
</div>
	<div th:replace="fragments/footer :: footer"></div>
<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        const monthlyExpensesLabels = /*[[${monthlyExpensesLabels}]]*/ [];
        const monthlyExpensesValues = /*[[${monthlyExpensesValues}]]*/ [];

        const ctx = document.getElementById('monthlyExpenseChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthlyExpensesLabels,
                datasets: [{
                    label: 'ì›”ë³„ ì´ ì§€ì¶œ (ì›)',
                    data: monthlyExpensesValues,
                    backgroundColor: 'rgba(255, 215, 0, 0.2)',
                    borderColor: '#FFD700',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'â‚©' + value.toLocaleString();
                            }
                        }
                    },
                    x: { 
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': â‚©' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-10px) scale(1.02)';
            });
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
            });
        });
        const feedbackArea = document.getElementById('chatGptFeedbackArea');
        const csrfToken = document.querySelector('input[name="_csrf"]')?.value;

        if (!csrfToken) {
            feedbackArea.innerHTML = '<p style="color: red;">ì˜¤ë¥˜: CSRF í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            console.error("CSRF token not found.");
            return;
        }
        function loadFeedbackAutomatically() {
            feedbackArea.innerHTML = '<p>í”¼ë“œë°±ì„ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...</p>';
            const selectedMetrics = [
                "totalExpense",
                "averageDailyExpense",
                "daysLeft",
                "remainingBudget"
            ];

            fetch('/consumption/getChatGptFeedbackForEanalysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': csrfToken
                },
                body: JSON.stringify({ selectedMetrics: selectedMetrics })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.feedback) {
                    feedbackArea.innerHTML = '<p id="chatGptFeedbackContent">' + data.feedback.replace(/\n/g, '<br>') + '</p>';
                } else if (data && data.error) {
                    feedbackArea.innerHTML = '<p style="color: red;">ì˜¤ë¥˜: ' + data.error + '</p>';
                } else {
                    feedbackArea.innerHTML = '<p>í”¼ë“œë°±ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                }
            })
            .catch(error => {
                console.error('ChatGPT í”¼ë“œë°±ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                feedbackArea.innerHTML = '<p style="color: red;">í”¼ë“œë°± ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</p>';
            });
        }

        loadFeedbackAutomatically();

        // 'ìƒˆë¡œìš´ ì˜ˆì‚° ìƒì„±í•˜ê¸°' ë²„íŠ¼ì˜ move í•¨ìˆ˜ëŠ” ê¸°ì¡´ëŒ€ë¡œ ìœ ì§€
        function move() {
            const btn = event.target;
            btn.textContent = 'ì˜ˆì‚° ì„¤ì •ìœ¼ë¡œ ê°€ëŠ” ì¤‘...';
            btn.disabled = true;

            setTimeout(() => {
                btn.textContent = 'ìƒˆë¡œìš´ ì˜ˆì‚° ìƒì„±í•˜ê¸°';
                btn.disabled = false;

                window.location.href = '/consumption/bplanner';
            }, 2000);
        }
        
        // move1 í•¨ìˆ˜ë¥¼ DOMContentLoaded ìŠ¤ì½”í”„ ë‚´ì—ì„œ ì •ì˜í•˜ê³ ,
        // ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.
        async function handleMoveToCanalysis() {
            const btn = document.getElementById('moveToCanalysisBtn'); // IDë¡œ ë²„íŠ¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            btn.textContent = 'ì¢…í•© ë¶„ì„í•˜ëŠ” ì¤‘...';
            btn.disabled = true;

            const feedbackElement = document.getElementById('chatGptFeedbackContent');
            let aiFeedback = "";

            if (feedbackElement) {
                aiFeedback = feedbackElement.innerText;
            } else {
                console.warn("chatGptFeedbackContent ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í”¼ë“œë°±ì„ ë¹ˆ ë¬¸ìì—´ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.");
            }

            console.log("ì¢…í•©ë¶„ì„ì„ ìœ„í•´ ì €ì¥í•  AI í”¼ë“œë°± ë‚´ìš©:", aiFeedback);

            try {
                const response = await fetch('/consumption/cfeedset', { // ìˆ˜ì •ëœ ì»¨íŠ¸ë¡¤ëŸ¬ ì£¼ì†Œ
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken 
                    },
                    body: JSON.stringify({
                        feedbackContent: aiFeedback
                    })
                });

                if (!response.ok) {
                    const errorResult = await response.json().catch(() => {
                        return response.text().then(text => ({ message: text || 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜' }));
                    });
                    throw new Error(errorResult.message || `ì„œë²„ ì˜¤ë¥˜ ë°œìƒ: ${response.status}`);
                }

                const result = await response.json();
                console.log('ì¢…í•©ë¶„ì„ í”¼ë“œë°± ì €ì¥ ê²°ê³¼:', result);

                if (result.success) {
                    console.log("ì¢…í•©ë¶„ì„ í”¼ë“œë°± ì €ì¥ ì„±ê³µ:", result.message);
                } else {
                    alert("ì¢…í•©ë¶„ì„ í”¼ë“œë°± ì €ì¥ ì‹¤íŒ¨: " + result.message);
                }
            } catch (error) {
                console.error('ì¢…í•©ë¶„ì„ í”¼ë“œë°± ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                alert("ì¢…í•©ë¶„ì„ í”¼ë“œë°± ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            } finally {
                setTimeout(() => {
                    btn.textContent = 'ì¢…í•©ë¶„ì„ í™”ë©´ìœ¼ë¡œ ê°€ê¸°';
                    btn.disabled = false;
                    window.location.href = '/consumption/canalysis'; // í˜ì´ì§€ ì´ë™
                }, 2000);
            }
        }

        // 'ì¢…í•©ë¶„ì„ í™”ë©´ìœ¼ë¡œ ê°€ê¸°' ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        const moveToCanalysisButton = document.getElementById('moveToCanalysisBtn');
        if (moveToCanalysisButton) {
            moveToCanalysisButton.addEventListener('click', handleMoveToCanalysis);
        }
    });
    
    function logout() {
        if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
           window.location.href = '/logout';
        }
     }
</script>
</body>
</html>