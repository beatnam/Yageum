<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>가계부 소비분석 및 피드백</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
	<link rel="stylesheet" href="../css/e_analysis.css">
	<link rel="stylesheet" href="../css/common.css">
	
</head>
<body>
<div th:replace="fragments/header :: header"></div>
<div class="app-container">
	
	<div th:replace="fragments/c_sidebar :: c_sidebar"></div>
<input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">

    <div class="container">
	    <div class="stats-grid">
	        <div class="stat-card">
	            <div class="stat-icon">💳</div>
	            <div class="stat-label">이번달 달 총 지출</div>
	            <div class="stat-value" id="totalExpense">
	                &#8361;<span th:text="${totalExpense != null ? #numbers.formatDecimal(totalExpense, 0, 'COMMA', 0, 'POINT') : '데이터 없음'}">0</span>
	            </div>
	        </div>
	        <div class="stat-card">
	            <div class="stat-icon">📊</div>
	            <div class="stat-label">하루 평균 지출</div>
	            <div class="stat-value" id="averageDailyExpense">
	                &#8361;<span th:text="${averageDailyExpense != null ? #numbers.formatDecimal(averageDailyExpense, 0, 'COMMA', 0, 'POINT') : '데이터 없음'}">0</span>
	            </div>
	        </div>
	        <div class="stat-card">
	            <div class="stat-icon">⏳</div>
	            <div class="stat-label">남은 일수</div>
	            <div class="stat-value" id="daysLeft" th:text="${daysLeft != null ? daysLeft + '일' : '데이터 없음'}">0일</div>
	        </div>
	        <div class="stat-card">
	            <div class="stat-icon">💰</div>
	            <div class="stat-label">남은 예산</div>
	            <div class="stat-value" id="remainingBudget">
	                &#8361;<span th:text="${remainingBudget != null ? #numbers.formatDecimal(remainingBudget, 0, 'COMMA', 0, 'POINT') : '데이터 없음'}">0</span>
	            </div>
	        </div>
	    </div>
	
	    <div class="chart-section">
	        <h2>월별 지출 추이</h2>
	        <div class="chart-container">
	            <canvas id="monthlyExpenseChart"></canvas>
	        </div>
	    </div>

        <div class="feedback-section">
            <h2>ChatGPT의 소비 피드백</h2>
            <div id="chatGptFeedbackArea">
                <p>피드백을 로드 중입니다...</p> </div>
        </div>
		<div class="savings-goal-section">
		    <h2>📊 지난달 절약 목표</h2>
		
		    <div th:if="${savingsPlan != null and not #maps.isEmpty(savingsPlan)}" class="goal-details-card">
		        <div class="goal-item">
		            <span class="goal-label">목표:</span>
		            <span class="goal-value" th:text="${savingsPlan['save_name'] ?: '미설정'}">목표명</span>
		        </div>
		        <div class="goal-item">
		            <span class="goal-label">목표 금액:</span>
		            <span class="goal-value" th:text="${'₩' + #numbers.formatInteger(savingsPlan['save_amount'] ?: 0, 0, 'COMMA')}">₩0</span>
		        </div>
		        <div class="goal-item">
		            <span class="goal-label">시작일:</span>
		            <span class="goal-value" th:text="${savingsPlan['save_created_date'] != null ? #temporals.format(savingsPlan['save_created_date'], 'yyyy-MM-dd') : '데이터 없음'}">YYYY-MM-DD</span>
		        </div>
		        <div class="goal-item">
		            <span class="goal-label">목표 달성일:</span>
		            <span class="goal-value" th:text="${savingsPlan['save_target_date'] != null ? #temporals.format(savingsPlan['save_target_date'], 'yyyy-MM-dd') : '데이터 없음'}">YYYY-MM-DD</span>
		        </div>
		        <div class="goal-item">
		            <span class="goal-label">지난달 저축가능 금액:</span>
		            <span class="goal-value" th:text="${previousMonthSavableAmount != null and previousMonthSavableAmount > 0 ? '₩' + #numbers.formatInteger(previousMonthSavableAmount, 0, 'COMMA') : '지난 달의 데이터가 없습니다.'}">₩0</span>
		        </div>
		
				<div class="budget-usage-section" th:if="${previousMonthBudgetUsageProgress != null and previousMonthBudgetUsageProgress >= 0}">
				    <h3 class="section-title">예산 사용률</h3> <div class="progress-bar-container"> <div class="progress-bar-bg">
				            <div class="progress-bar-fill"
				                 th:style="'width:' + ${#numbers.formatDecimal(previousMonthBudgetUsageProgress, 0, 0)} + '%'">
				                <span th:text="${#numbers.formatDecimal(previousMonthBudgetUsageProgress, 0, 0)} + '%'">0%</span>
				            </div>
				        </div>
				    </div>
				</div>
		    </div>
		
		    <div class="savings-plan-section" th:if="${savingsPlan == null or #maps.isEmpty(savingsPlan)}">
		        <p>지난달의 절약 목표 데이터가 없습니다. 새로운 예산을 설정하거나 이전 데이터를 확인해 보세요!</p>
		        <button class="btn" onclick="move()">새로운 예산 생성하기</button>
		    </div>
		
		    <div class="savings-plan-section" th:if="${savingsPlan != null and not #maps.isEmpty(savingsPlan)}">
		        <p>설정된 절약 목표가 있습니다. 종합분석으로 확실하게!</p>
		        <button class="btn" id="moveToCanalysisBtn">종합분석 화면으로 가기</button>
		    </div>
		</div>
	</div>
</div>
	<div th:replace="fragments/footer :: footer"></div>
<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        const monthlyExpensesLabels = /*[[${monthlyExpensesLabels}]]*/ [];
        const monthlyExpensesValues = /*[[${monthlyExpensesValues}]]*/ [];

        const ctx = document.getElementById('monthlyExpenseChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthlyExpensesLabels,
                datasets: [{
                    label: '월별 총 지출 (원)',
                    data: monthlyExpensesValues,
                    backgroundColor: 'rgba(255, 215, 0, 0.2)',
                    borderColor: '#FFD700',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₩' + value.toLocaleString();
                            }
                        }
                    },
                    x: { 
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ₩' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-10px) scale(1.02)';
            });
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
            });
        });

        const feedbackArea = document.getElementById('chatGptFeedbackArea');
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

        if (!csrfToken || !csrfHeader) {
            feedbackArea.innerHTML = '<p style="color: red;">오류: 보안 토큰(CSRF)을 찾을 수 없습니다. 페이지를 새로고침하거나 관리자에게 문의하세요.</p>';
            console.error("CSRF token or header name is missing.", { csrfToken, csrfHeader });
            return;
        }

        function loadFeedbackAutomatically() {
            feedbackArea.innerHTML = '<p>피드백을 로드 중입니다...</p>';
            const selectedMetrics = [
                "totalExpense",
                "averageDailyExpense",
                "daysLeft",
                "remainingBudget"
            ];

            fetch('/consumption/getChatGptFeedbackForEanalysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken 
                },
                body: JSON.stringify({ selectedMetrics: selectedMetrics })
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 403) {
                         throw new Error('인증 오류: 세션이 만료되었거나 접근 권한이 없습니다. 다시 로그인해주세요.');
                    }
                    throw new Error('네트워크 응답이 올바르지 않습니다: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.feedback) {
                    feedbackArea.innerHTML = '<p id="chatGptFeedbackContent">' + data.feedback.replace(/\n/g, '<br>') + '</p>';
                } else if (data && data.error) {
                    feedbackArea.innerHTML = '<p style="color: red;">오류: ' + data.error + '</p>';
                } else {
                    feedbackArea.innerHTML = '<p>피드백을 가져오지 못했습니다.</p>';
                }
            })
            .catch(error => {
                console.error('ChatGPT 피드백을 가져오는 중 오류 발생:', error);
                feedbackArea.innerHTML = '<p style="color: red;">피드백 로드 중 오류가 발생했습니다: ' + error.message + '</p>';
            });
        }

        loadFeedbackAutomatically();

        function move() {
            const btn = event.target;
            btn.textContent = '예산 설정으로 가는 중...';
            btn.disabled = true;

            setTimeout(() => {
                btn.textContent = '새로운 예산 생성하기';
                btn.disabled = false;

                window.location.href = '/consumption/bplanner';
            }, 2000);
        }
        
        async function handleMoveToCanalysis() {
            const btn = document.getElementById('moveToCanalysisBtn');
            btn.textContent = '종합 분석하는 중...';
            btn.disabled = true;

            const feedbackElement = document.getElementById('chatGptFeedbackContent');
            let budFeedbackContent = "";

            if (feedbackElement) {
                budFeedbackContent = feedbackElement.innerText;
            } else {
                console.warn("chatGptFeedbackContent 요소를 찾을 수 없습니다. 피드백을 빈 문자열로 처리합니다.");
            }

            console.log("종합분석을 위해 저장할 AI 피드백 내용 (bud_feedback):", budFeedbackContent);

            let shouldProceedToSave = true;

            try {
                const checkBudFeedbackUrl = '/consumption/hasBudFeedback';
                const checkResponse = await fetch(checkBudFeedbackUrl, {
                    method: 'GET',
                    headers: {
                        [csrfHeader]: csrfToken 
                    }
                });

                if (!checkResponse.ok) {
                     if (checkResponse.status === 403) {
                         throw new Error('인증 오류: 세션이 만료되었거나 접근 권한이 없습니다. 다시 로그인해주세요.');
                     }
                    throw new Error(`bud_feedback 존재 여부 확인 실패: ${checkResponse.status} ${checkResponse.statusText}`);
                }
                const checkResult = await checkResponse.json();

                if (checkResult.exists) {
                    const confirmOverwrite = confirm("저장된 종합분석 피드백이 있습니다. 현재 내용으로 덮어쓰시겠습니까?\n'예'를 누르면 업데이트되고, '아니오'를 누르면 저장 없이 다음 페이지로 이동합니다.");
                    if (!confirmOverwrite) {
                        shouldProceedToSave = false;
                    }
                }

                if (shouldProceedToSave) {
                    console.log("종합분석 피드백 저장을 시도합니다.");
                    const saveResponse = await fetch('/consumption/cfeedset', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken 
                        },
                        body: JSON.stringify({
                            feedbackContent: budFeedbackContent
                        })
                    });

                    if (!saveResponse.ok) {
                         if (saveResponse.status === 403) {
                             throw new Error('인증 오류: 세션이 만료되었거나 접근 권한이 없습니다. 다시 로그인해주세요.');
                         }
                        const errorResult = await saveResponse.json().catch(() => {
                            return saveResponse.text().then(text => ({ message: text || '알 수 없는 서버 오류' }));
                        });
                        throw new Error(errorResult.message || `서버 오류 발생: ${saveResponse.status}`);
                    }

                    const saveResult = await saveResponse.json();
                    console.log('종합분석 피드백 저장 결과:', saveResult);

                    if (saveResult.success) {
                        console.log("종합분석 피드백 저장 성공:", saveResult.message);
                    } else {
                        alert("종합분석 피드백 저장 실패: " + saveResult.message);
                    }
                } else {
                    console.log("종합분석 피드백 저장을 취소하고 다음 페이지로 이동합니다.");
                }

                setTimeout(() => {
                    btn.textContent = '종합분석 화면으로 가기';
                    btn.disabled = false;
                    window.location.href = '/consumption/canalysis';
                }, 1000);

            } catch (error) {
                console.error('종합분석 피드백 처리 중 오류 발생:', error);
                alert("피드백 처리 중 오류가 발생했습니다: " + error.message);
                btn.textContent = '종합분석 화면으로 가기';
                btn.disabled = false;
            }
        }

        const moveToCanalysisButton = document.getElementById('moveToCanalysisBtn');
        if (moveToCanalysisButton) {
            moveToCanalysisButton.addEventListener('click', handleMoveToCanalysis);
        }
    });
    
    function logout() {
        if (confirm('로그아웃 하시겠습니까?')) {
           window.location.href = '/logout';
        }
     }
</script>
</body>
</html>