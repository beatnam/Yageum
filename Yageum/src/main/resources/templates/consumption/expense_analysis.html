<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ê³„ë¶€ ì†Œë¹„ë¶„ì„ ë° í”¼ë“œë°±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
	<link rel="stylesheet" href="../css/e_analysis.css">
	<link rel="stylesheet" href="../css/common.css">
</head>
<body>
<div th:replace="fragments/header :: header"></div>
<div class="app-container">
	
	<div th:replace="fragments/c_sidebar :: c_sidebar"></div>
<input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ’³</div>
                <div class="stat-label">ì´ë²ˆ ë‹¬ ì´ ì§€ì¶œ</div>
                <div class="stat-value" id="totalExpense">&#8361;<span th:text="${#numbers.formatDecimal(totalExpense, 0, 'COMMA', 0, 'POINT')}">0</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-label">í•˜ë£¨ í‰ê·  ì§€ì¶œ</div>
                <div class="stat-value" id="averageDailyExpense">&#8361;<span th:text="${#numbers.formatDecimal(averageDailyExpense, 0, 'COMMA', 0, 'POINT')}">0</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">â³</div>
                <div class="stat-label">ë‚¨ì€ ì¼ìˆ˜</div>
                <div class="stat-value" id="daysLeft" th:text="${daysLeft + 'ì¼'}">0ì¼</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ’°</div>
                <div class="stat-label">ë‚¨ì€ ì˜ˆì‚°</div>
                <div class="stat-value" id="remainingBudget">&#8361;<span th:text="${#numbers.formatDecimal(remainingBudget, 0, 'COMMA', 0, 'POINT')}">0</span></div>
            </div>
        </div>

        <div class="chart-section">
            <h2>ì›”ë³„ ì§€ì¶œ ì¶”ì´</h2>
            <div class="chart-container">
                <canvas id="monthlyExpenseChart"></canvas>
            </div>
        </div>

        <div class="feedback-section">
            <h2>ChatGPTì˜ ì†Œë¹„ í”¼ë“œë°±</h2>
            <div id="chatGptFeedbackArea">
                <p>í”¼ë“œë°±ì„ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...</p> </div>
        </div>
        <div class="savings-goal-section">
            <h2>ğŸ“Š ì§€ë‚œë‹¬ ì ˆì•½ ëª©í‘œ</h2>
            <div th:if="${savingsPlan != null and not #maps.isEmpty(savingsPlan)}" class="goal-details-card">
                <div class="goal-item">
                    <span class="goal-label">ëª©í‘œ:</span>
                    <span class="goal-value" th:text="${savingsPlan['save_name'] ?: 'ì„¤ì •ë˜ì§€ ì•ŠìŒ'}">ëª©í‘œëª…</span>
                </div>
                <div class="goal-item">
                    <span class="goal-label">ëª©í‘œ ê¸ˆì•¡:</span>
                    <span class="goal-value" th:text="${'â‚©' + #numbers.formatInteger(savingsPlan['save_amount'] ?: 0, 0, 'COMMA')}">â‚©0</span>
                </div>
                <div class="goal-item">
                    <span class="goal-label">ì‹œì‘ì¼:</span>
                    <span class="goal-value" th:text="${savingsPlan['save_created_date'] != null ? #temporals.format(savingsPlan['save_created_date'], 'yyyy-MM-dd') : 'ë¯¸ì •'}">YYYY-MM-DD</span>
                </div>
                <div class="goal-item">
                    <span class="goal-label">ëª©í‘œ ë‹¬ì„±ì¼:</span>
                    <span class="goal-value" th:text="${savingsPlan['save_target_date'] != null ? #temporals.format(savingsPlan['save_target_date'], 'yyyy-MM-dd') : 'ë¯¸ì •'}">YYYY-MM-DD</span>
                </div>
                <div class="goal-item">
                    <span class="goal-label">ì§€ë‚œë‹¬ ì €ì¶•ê°€ëŠ¥ ê¸ˆì•¡:</span>
                    <span class="goal-value" th:text="${'â‚©' + #numbers.formatInteger(remainingBudget, 0, 'COMMA')}">â‚©0</span>
                </div>
                <div class="progress-bar-container">
				    <div class="progress-bar-label">ì˜ˆì‚° ì‚¬ìš©ë¥ :</div> <div class="progress-bar-bg">
				        <div class="progress-bar-fill"
				             th:style="'width:' + ${#numbers.formatDecimal(budgetUsageProgress, 0, 0)} + '%'">
				            <span th:text="${#numbers.formatDecimal(budgetUsageProgress, 0, 0)} + '%'">0%</span>
				        </div>
				    </div>
				</div>
            </div>
        
        <div class="savings-plan-section" th:if="${savingsPlan == null or #maps.isEmpty(savingsPlan)}">
            <p>ì„¤ì •ëœ ì ˆì•½ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ì˜ˆì‚°ì„ ì„¤ì •í•´ ë³´ì„¸ìš”!</p>
            <button class="btn" onclick="move()">ìƒˆë¡œìš´ ì˜ˆì‚° ìƒì„±í•˜ê¸°</button>
        </div>
        <div class="savings-plan-section" th:if="${savingsPlan != null}">
            <p>ì„¤ì •ëœ ì ˆì•½ ëª©í‘œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…í•©ë¶„ì„ìœ¼ë¡œ í™•ì‹¤í•˜ê²Œ!</p>
            <button class="btn" onclick="move1()">ì¢…í•©ë¶„ì„ í™”ë©´ìœ¼ë¡œ ê°€ê¸°</button>
        </div>
	</div>
</div>
</div>
	<div th:replace="fragments/footer :: footer"></div>
<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener("DOMContentLoaded", function () {
        // Thymeleafì—ì„œ JSON ë¬¸ìì—´ë¡œ ì „ë‹¬ëœ ë°ì´í„°ë¥¼ JavaScript ê°ì²´ë¡œ íŒŒì‹±
        const monthlyExpensesLabels = JSON.parse(/*[[${monthlyExpensesLabels}]]*/ '[]');
        const monthlyExpensesValues = JSON.parse(/*[[${monthlyExpensesValues}]]*/ '[]');

        // ì›”ë³„ ì§€ì¶œ ì¶”ì´ ê·¸ë˜í”„
        const ctx = document.getElementById('monthlyExpenseChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthlyExpensesLabels, // ì´ì œ ì‹¤ì œ JavaScript ë°°ì—´ì…ë‹ˆë‹¤.
                datasets: [{
                    label: 'ì›”ë³„ ì´ ì§€ì¶œ (ì›)',
                    data: monthlyExpensesValues, // ì´ì œ ì‹¤ì œ JavaScript ë°°ì—´ì…ë‹ˆë‹¤.
                    backgroundColor: 'rgba(255, 215, 0, 0.2)',
                    borderColor: '#FFD700',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'â‚©' + value.toLocaleString();
                            }
                        }
                    },
                    x: { // xì¶•ë„ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë‚ ì§œ/ì›”ë³„ ë ˆì´ë¸”ì´ ì˜¬ë°”ë¥´ê²Œ í‘œì‹œë˜ë„ë¡ í•©ë‹ˆë‹¤.
                        // type: 'category' ë˜ëŠ” ê¸°ë³¸ ì„¤ì • (auto)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
                        // í•„ìš”ì— ë”°ë¼ 'time' íƒ€ì…ì„ ì‚¬ìš©í•˜ë ¤ë©´ Chart.js adapterê°€ í•„ìš”í•©ë‹ˆë‹¤.
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': â‚©' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // ì¹´ë“œ hover íš¨ê³¼ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-10px) scale(1.02)';
            });
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
            });
        });

        // --- ChatGPT í”¼ë“œë°± ë¡œë“œ ë¡œì§ (ìë™ ì‹¤í–‰) ---
        const feedbackArea = document.getElementById('chatGptFeedbackArea');
        const csrfToken = document.querySelector('input[name="_csrf"]')?.value; // CSRF í† í° ê°€ì ¸ì˜¤ê¸° (POST ìš”ì²­ ì‹œ í•„ìš”)

        if (!csrfToken) {
            feedbackArea.innerHTML = '<p style="color: red;">ì˜¤ë¥˜: CSRF í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            console.error("CSRF token not found.");
            return;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ í”¼ë“œë°±ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        function loadFeedbackAutomatically() {
            feedbackArea.innerHTML = '<p>í”¼ë“œë°±ì„ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...</p>'; // ë¡œë”© ë©”ì‹œì§€

            // ëª¨ë“  ì§€í‘œë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ ì„ íƒëœ ê²ƒìœ¼ë¡œ ê°„ì£¼í•˜ê³  í”„ë¡¬í”„íŠ¸ì— í¬í•¨
            // ë°±ì—”ë“œì˜ `getChatGptFeedbackForEfeedback` ë©”ì„œë“œê°€ ì´ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°›ì„ ê²ƒì…ë‹ˆë‹¤.
            const selectedMetrics = [
                "totalExpense",
                "averageDailyExpense",
                "daysLeft",
                "remainingBudget"
            ];
            // ë§Œì•½ ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ í”¼ë“œë°±ë„ í•­ìƒ í¬í•¨í•˜ê³  ì‹¶ë‹¤ë©´, ë°±ì—”ë“œ ë¡œì§ì—ì„œ í•­ìƒ í¬í•¨í•˜ë„ë¡ í•˜ê±°ë‚˜,
            // ì—¬ê¸°ì— 'categoryExpenses' ê°™ì€ ê°’ë„ ì¶”ê°€í•˜ê³  ë°±ì—”ë“œì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

            fetch('/consumption/getChatGptFeedbackForEanalysis', { // ìš”ì²­ ì£¼ì†Œë¥¼ ëª…í™•íˆ ì§€ì •
                method: 'POST', // POST ìš”ì²­
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': csrfToken // CSRF í† í° í—¤ë”ì— í¬í•¨
                },
                // ì„ íƒëœ ì§€í‘œ ëª©ë¡ì„ JSON ë°°ì—´ë¡œ ì „ì†¡
                body: JSON.stringify({ selectedMetrics: selectedMetrics })
            })
            .then(response => {
                if (!response.ok) {
                    // ì‘ë‹µì´ ì„±ê³µ(200ë²ˆëŒ€)ì´ ì•„ë‹ˆë©´ ì˜¤ë¥˜ ì²˜ë¦¬
                    throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.feedback) {
                    // ì¤„ë°”ê¿ˆ ë¬¸ìë¥¼ <br> íƒœê·¸ë¡œ ë³€í™˜í•˜ì—¬ HTMLì— ì˜¬ë°”ë¥´ê²Œ í‘œì‹œ
                    feedbackArea.innerHTML = '<p>' + data.feedback.replace(/\n/g, '<br>') + '</p>';
                } else if (data && data.error) { // ë°±ì—”ë“œì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ê²½ìš°
                    feedbackArea.innerHTML = '<p style="color: red;">ì˜¤ë¥˜: ' + data.error + '</p>';
                } else {
                    feedbackArea.innerHTML = '<p>í”¼ë“œë°±ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                }
            })
            .catch(error => {
                console.error('ChatGPT í”¼ë“œë°±ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                feedbackArea.innerHTML = '<p style="color: red;">í”¼ë“œë°± ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</p>';
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ í”¼ë“œë°± ìë™ í˜¸ì¶œ
        loadFeedbackAutomatically();

        // ê¸°ì¡´ì˜ move í•¨ìˆ˜ë“¤ (ì˜ˆì‚° ì„¤ì •, ì¢…í•© ë¶„ì„ í™”ë©´ ì´ë™)ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
        function move() {
            const btn = event.target;
            btn.textContent = 'ì˜ˆì‚° ì„¤ì •ìœ¼ë¡œ ê°€ëŠ” ì¤‘...';
            btn.disabled = true;

            setTimeout(() => {
                btn.textContent = 'ìƒˆë¡œìš´ ì˜ˆì‚° ìƒì„±í•˜ê¸°';
                btn.disabled = false;

                window.location.href = '/consumption/bplanner';
            }, 2000);
        }
        
        function move1() {
            const btn = event.target;
            btn.textContent = 'ì¢…í•© ë¶„ì„í•˜ëŠ” ì¤‘...';
            btn.disabled = true;

            setTimeout(() => {
                btn.textContent = 'ì¢…í•©ë¶„ì„ í™”ë©´ìœ¼ë¡œ ê°€ê¸°';
                btn.disabled = false;

                window.location.href = '/consumption/canalysis';
            }, 2000);
        }
    });
    /*]]>*/
</script>
</body>
</html>