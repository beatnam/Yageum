<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가계부 소비분석 및 피드백</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
	<link rel="stylesheet" href="../css/e_analysis.css">
	<link rel="stylesheet" href="../css/common.css">
</head>
<body>
<div th:replace="fragments/header :: header"></div>
<div class="app-container">
	
	<!--사이드 메뉴 바-->
<div th:replace="fragments/c_sidebar :: c_sidebar"></div>
<input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">💳</div>
                <div class="stat-label">이번 달 총 지출</div>
                <div class="stat-value" id="totalExpense" th:text="'₩' + ${#numbers.formatInteger(totalExpense, 0, 'COMMA')}">₩0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📈</div>
                <div class="stat-label">일 평균 지출</div>
                <div class="stat-value" id="averageDailyExpense" th:text="'₩' + ${#numbers.formatInteger(averageDailyExpense, 0, 'COMMA')}">₩0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">💰</div>
                <div class="stat-label">남은 예산</div>
                <div class="stat-value" id="remainingBudget" th:text="'₩' + ${#numbers.formatInteger(remainingBudget, 0, 'COMMA')}">₩0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🗓️</div>
                <div class="stat-label">남은 일 수</div>
                <div class="stat-value" id="daysLeft" th:text="${daysLeft + '일'}">0일</div>
            </div>
        </div>

        <div class="goal-section" th:if="${savingsPlan != null}"> <h2>나의 절약 목표</h2>
            <div class="goal-card">
                <div class="goal-header">
                    <div class="goal-title" th:text="${savingsPlan.plan_name}"></div> <div class="goal-status status-info">진행 중</div>
                </div>
                <div class="goal-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%;" th:style="'width: ' + (${#numbers.formatDecimal(savingsPlan.plan_amount / 10000.0, 1, 0, false, 0, 0)}) + '%'"></div> </div>
                    <div class="progress-text">
                        <span th:text="'목표: ₩' + ${#numbers.formatInteger(savingsPlan.plan_amount, 0, 'COMMA')}">₩0</span> <span>달성률: <span th:text="${#numbers.formatDecimal(savingsPlan.plan_amount / 10000.0, 1, 0, false, 0, 0)} + '%'">0%</span></span> </div>
                </div>
                <p class="goal-feedback" th:text="${savingsPlan.plan_feedback}">피드백 내용</p> <div class="goal-meta">
                    <span>생성일: <span th:text="${#dates.format(savingsPlan.plan_created_date, 'yyyy-MM-dd')}"></span></span> <span th:if="${savingsPlan.plan_target_date != null}"> | 목표일: <span th:text="${#dates.format(savingsPlan.plan_target_date, 'yyyy-MM-dd')}"></span></span> </div>
            </div>
            <button class="btn" onclick="move()">새로운 예산 생성하기</button>
        </div>
        <div class="goal-section" th:if="${savingsPlan == null}"> <h2>나의 절약 목표</h2>
            <div class="goal-card">
                <p>아직 설정된 절약 목표가 없습니다. 새로운 목표를 세워보세요!</p>
            </div>
            <button class="btn" onclick="move()">새로운 예산 생성하기</button>
        </div>

        <div class="chart-section">
            <h2>월별 지출 추이</h2>
            <div class="chart-container">
                <canvas id="monthlyExpenseChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener("DOMContentLoaded", function () {
        // 그래프 데이터 (컨트롤러에서 전달받음)
        const monthlyExpensesLabels = [[${monthlyExpensesLabels}]];
        const monthlyExpensesValues = [[${monthlyExpensesValues}]];

        // 월별 지출 추이 그래프
        const ctx = document.getElementById('monthlyExpenseChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthlyExpensesLabels,
                datasets: [{
                    label: '월별 총 지출 (원)',
                    data: monthlyExpensesValues,
                    backgroundColor: 'rgba(255, 215, 0, 0.2)',
                    borderColor: '#FFD700',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₩' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ₩' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // 카드 hover 효과 (기존 코드 유지)
        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-10px) scale(1.02)';
            });
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
            });
        });

        function move() {
            const btn = event.target;
            btn.textContent = '예산 설정으로 가는 중...';
            btn.disabled = true;

            setTimeout(() => {
                btn.textContent = '새로운 예산 생성하기';
                btn.disabled = false;

                window.location.href = '/consumption/bplanner';
            }, 2000);
        }
    });
    /*]]>*/
</script>
</body>
</html>