<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <title>가계부 예산 설정</title>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="../css/common.css">
	<link rel="stylesheet" href="../css/b_planner.css">
	
</head>
<body>
<div th:replace="fragments/header :: header"></div>
<div class="app-container">
	
	<!--  사이드 바 메뉴 -->
<div th:replace="fragments/c_sidebar :: c_sidebar"></div>
<input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">


    <div class="container">
    
        <div class="budget-header pulse-animation">
            <h1>가계부 예산 설정</h1>
            <p>현명한 가계 관리를 위한 예산 계획을 세워보세요</p>
        </div>

        <div class="budget-grid">
            <div class="budget-card">
                <h2 class="card-title">수입 설정</h2>
                <div class="input-group">
                    <label for="income-source">수입원</label>
                    <select id="income-source">
                        <option value="">수입원을 선택하세요</option>
                        <option value="급여">급여</option>
                        <option value="부업">부업</option>
                        <option value="투자수익">투자수익</option>
                        <option value="기타">기타</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="income-amount">금액 (원)</label>
                    <input type="number" id="income-amount" placeholder="수입 금액을 입력하세요">
                </div>
                <button class="btn btn-add" onclick="addIncome()">수입 추가</button>
                
                <div class="category-list" id="income-list">
                    <div class="category-item">
                        <span class="category-name">등록된 수입이 없습니다</span>
                        <span class="category-amount">₩0</span>
                    </div>
                </div>
            </div>

            <div class="budget-card">
                <h2 class="card-title">지출 예산 설정</h2>
                <div class="input-group">
                    <label for="expense-category">지출 카테고리</label>
                    <select id="expense-category">
                        <option value="">카테고리를 선택하세요</option>
                        <option value="식비">식비</option>
                        <option value="교통비">교통비</option>
                        <option value="주거비">주거비</option>
                        <option value="의료비">의료비</option>
                        <option value="교육비">교육비</option>
                        <option value="쇼핑">쇼핑</option>
                        <option value="문화생활">문화생활</option>
                        <option value="기타">기타</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="expense-amount">예산 금액 (원)</label>
                    <input type="number" id="expense-amount" placeholder="예산 금액을 입력하세요">
                </div>
                <button class="btn btn-add" onclick="addExpense()">예산 추가</button>
                
                <div class="category-list" id="expense-list">
                    <div class="category-item">
                        <span class="category-name">등록된 예산이 없습니다</span>
                        <span class="category-amount">₩0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="total-section">
            <h2>예산</h2>
            <input type="text" id="income-amount" name="save_name" placeholder="목표 이름을 입력해주세요.">
            <div style="display: flex; justify-content: space-around; flex-wrap: wrap; margin: 20px 0;">
            	
                <div>
                    <p>총 수입</p>
                    <div class="total-amount" id="total-income">₩0</div>
                </div>
                <div>
                    <p>총 예산</p>
                    <div class="total-amount" id="total-expense">₩0</div>
                </div>
                <div>
                    <p>잔여 예산</p>
                    <div class="total-amount" id="remaining-budget">₩0</div>
                </div>
            </div>
        </div>
        <div class="action-buttons">
            <button class="btn btn-save" onclick="saveBudget()">예산 저장</button>
            <button class="btn btn-reset" onclick="resetBudget()">초기화</button>
        </div>
	</div>	
</div>
        
	<div th:replace="fragments/footer :: footer"></div>
    <script>
        let incomes = [];
        let expenses = [];

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW'
            }).format(amount);
        }

        function addIncome() {
            const source = document.getElementById('income-source').value;
            const amount = parseInt(document.getElementById('income-amount').value);

            if (!source || !amount || amount <= 0) {
                alert('수입원과 유효한 금액을 입력해주세요.');
                return;
            }

            incomes.push({ source, amount });
            updateIncomeList();
            updateTotals();
            
            document.getElementById('income-source').value = '';
            document.getElementById('income-amount').value = '';
        }

        function addExpense() {
            const category = document.getElementById('expense-category').value;
            const amount = parseInt(document.getElementById('expense-amount').value);

            if (!category || !amount || amount <= 0) {
                alert('카테고리와 유효한 금액을 입력해주세요.');
                return;
            }

            expenses.push({ category, amount });
            updateExpenseList();
            updateTotals();
            
            document.getElementById('expense-category').value = '';
            document.getElementById('expense-amount').value = '';
        }

        function updateIncomeList() {
            const list = document.getElementById('income-list');
            
            if (incomes.length === 0) {
                list.innerHTML = '<div class="category-item"><span class="category-name">등록된 수입이 없습니다</span><span class="category-amount">₩0</span></div>';
                return;
            }

            list.innerHTML = incomes.map((income, index) => `
                <div class="category-item">
                    <span class="category-name">${income.source}</span>
                    <div>
                        <span class="category-amount">${formatCurrency(income.amount)}</span>
                        <button class="delete-btn" onclick="removeIncome(${index})">삭제</button>
                    </div>
                </div>
            `).join('');
        }

        function updateExpenseList() {
            const list = document.getElementById('expense-list');
            
            if (expenses.length === 0) {
                list.innerHTML = '<div class="category-item"><span class="category-name">등록된 예산이 없습니다</span><span class="category-amount">₩0</span></div>';
                return;
            }

            list.innerHTML = expenses.map((expense, index) => `
                <div class="category-item">
                    <span class="category-name">${expense.category}</span>
                    <div>
                        <span class="category-amount">${formatCurrency(expense.amount)}</span>
                        <button class="delete-btn" onclick="removeExpense(${index})">삭제</button>
                    </div>
                </div>
            `).join('');
        }

        function removeIncome(index) {
            incomes.splice(index, 1);
            updateIncomeList();
            updateTotals();
        }

        function removeExpense(index) {
            expenses.splice(index, 1);
            updateExpenseList();
            updateTotals();
        }

        function updateTotals() {
            const totalIncome = incomes.reduce((sum, income) => sum + income.amount, 0);
            const totalExpense = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const remaining = totalIncome - totalExpense;

            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expense').textContent = formatCurrency(totalExpense);
            
            const remainingElement = document.getElementById('remaining-budget');
            remainingElement.textContent = formatCurrency(remaining);
            remainingElement.style.color = remaining >= 0 ? '#2ecc71' : '#e74c3c';
        }

        function saveBudget() {
            if (incomes.length === 0 && expenses.length === 0) {
                alert('저장할 예산 데이터가 없습니다.');
                return;
            }

            const totalIncome = incomes.reduce((sum, item) => sum + item.amount, 0); // 총 수입 계산

            // 'name="save_name"'을 가진 input 필드의 값을 가져옵니다.
            const saveNameInput = document.querySelector('input[name="save_name"]'); 
            const saveNameValue = saveNameInput ? saveNameInput.value.trim() : '';

            if (saveNameValue === '') {
                alert('예산 목표 이름을 입력해주세요.');
                if (saveNameInput) {
                    saveNameInput.focus();
                }
                return;
            }

            // ⭐★★ CSRF 토큰 가져오는 부분 다시 확인 및 강화 ★★⭐
            const csrfTokenElement = document.querySelector('input[name="_csrf"]');
            const csrfToken = csrfTokenElement ? csrfTokenElement.value : null;

            // Spring Security의 기본 CSRF 헤더 이름은 'X-CSRF-TOKEN'입니다.
            // 만약 Thymeleaf의 meta 태그로 `_csrf_header`를 사용한다면 그 값을 따르고, 없으면 기본값 사용.
            const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
            const csrfHeaderName = csrfHeaderMeta ? csrfHeaderMeta.content : 'X-CSRF-TOKEN'; // 기본값 'X-CSRF-TOKEN'

            // fetch 요청에 포함될 헤더 객체를 생성합니다.
            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };

            // CSRF 토큰이 존재하면 헤더에 추가합니다.
            if (csrfToken && csrfHeaderName) {
                headers[csrfHeaderName] = csrfToken; // 동적으로 헤더 이름과 값을 추가합니다.
            } else {
                console.warn("CSRF 토큰 또는 헤더 이름을 찾을 수 없습니다. 보안 문제가 발생할 수 있습니다.");
            }

            // 서버로 전송할 데이터
            const dataToSend = {
                totalIncome: totalIncome,
                save_name: saveNameValue
            };

            fetch('/consumption/bplannerPro', {
                method: 'POST',
                headers: headers, // ⭐★★ 수정된 headers 객체를 사용합니다. ★★⭐
                body: JSON.stringify(dataToSend)
            })
            .then(response => {
                // 403 Forbidden 에러를 특별히 처리하여 사용자에게 로그인 필요 등의 메시지 전달
                if (response.status === 403) {
                    return response.json().then(errorData => {
                        throw new new Error(errorData.message || '인증 오류: 접근이 거부되었습니다. 다시 로그인해주세요.');
                    }).catch(() => {
                        // JSON 파싱 실패 시 (예: HTML 에러 페이지 반환 시) 기본 메시지
                        throw new Error('인증 오류: 접근이 거부되었습니다. 페이지를 새로고침하거나 다시 로그인해주세요.');
                    });
                }
                if (!response.ok) { // 2xx 외의 다른 상태 코드 처리
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || '예산 저장 중 오류 발생');
                    });
                }
                return response.json(); // 성공적인 2xx 응답인 경우 JSON 파싱
            })
            .then(data => {
                if (data.success) {
                    alert(data.message + ' 💾');
                    window.location.href = '/consumption/canalysis';
                } else {
                    alert('저장 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('예산 저장 중 네트워크 또는 기타 오류 발생:', error);
                alert('예산 저장 중 오류가 발생했습니다: ' + error.message);
            });
        }

        function resetBudget() {
            if (confirm('모든 예산 데이터를 초기화하시겠습니까?')) {
                incomes = [];
                expenses = [];
                updateIncomeList();
                updateExpenseList();
                updateTotals();
                alert('예산이 초기화되었습니다. 🔄');
            }
        }

        // 페이지 로드시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            updateIncomeList();
            updateExpenseList();
            updateTotals();
        });
        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
               window.location.href = '/logout';
            }
         }
    </script>
</body>
</html>