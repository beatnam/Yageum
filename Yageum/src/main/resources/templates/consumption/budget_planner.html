<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <title>ê°€ê³„ë¶€ ì˜ˆì‚° ì„¤ì •</title>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="../css/common.css">
	<link rel="stylesheet" href="../css/b_planner.css">
	
</head>
<body>
<div th:replace="fragments/header :: header"></div>
<div class="app-container">
	
	<!--  ì‚¬ì´ë“œ ë°” ë©”ë‰´ -->
<div th:replace="fragments/c_sidebar :: c_sidebar"></div>
<input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">


    <div class="container">
    
        <div class="budget-header pulse-animation">
            <h1>ê°€ê³„ë¶€ ì˜ˆì‚° ì„¤ì •</h1>
            <p>í˜„ëª…í•œ ê°€ê³„ ê´€ë¦¬ë¥¼ ìœ„í•œ ì˜ˆì‚° ê³„íšì„ ì„¸ì›Œë³´ì„¸ìš”</p>
        </div>

        <div class="budget-grid">
            <div class="budget-card">
                <h2 class="card-title">ìˆ˜ì… ì„¤ì •</h2>
                <div class="input-group">
                    <label for="income-source">ìˆ˜ì…ì›</label>
                    <select id="income-source">
                        <option value="">ìˆ˜ì…ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="ê¸‰ì—¬">ê¸‰ì—¬</option>
                        <option value="ë¶€ì—…">ë¶€ì—…</option>
                        <option value="íˆ¬ììˆ˜ìµ">íˆ¬ììˆ˜ìµ</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="income-amount">ê¸ˆì•¡ (ì›)</label>
                    <input type="number" id="income-amount" placeholder="ìˆ˜ì… ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <button class="btn btn-add" onclick="addIncome()">ìˆ˜ì… ì¶”ê°€</button>
                
                <div class="category-list" id="income-list">
                    <div class="category-item">
                        <span class="category-name">ë“±ë¡ëœ ìˆ˜ì…ì´ ì—†ìŠµë‹ˆë‹¤</span>
                        <span class="category-amount">â‚©0</span>
                    </div>
                </div>
            </div>

            <div class="budget-card">
                <h2 class="card-title">ì§€ì¶œ ì˜ˆì‚° ì„¤ì •</h2>
                <div class="input-group">
                    <label for="expense-category">ì§€ì¶œ ì¹´í…Œê³ ë¦¬</label>
                    <select id="expense-category">
                        <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="ì‹ë¹„">ì‹ë¹„</option>
                        <option value="êµí†µë¹„">êµí†µë¹„</option>
                        <option value="ì£¼ê±°ë¹„">ì£¼ê±°ë¹„</option>
                        <option value="ì˜ë£Œë¹„">ì˜ë£Œë¹„</option>
                        <option value="êµìœ¡ë¹„">êµìœ¡ë¹„</option>
                        <option value="ì‡¼í•‘">ì‡¼í•‘</option>
                        <option value="ë¬¸í™”ìƒí™œ">ë¬¸í™”ìƒí™œ</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="expense-amount">ì˜ˆì‚° ê¸ˆì•¡ (ì›)</label>
                    <input type="number" id="expense-amount" placeholder="ì˜ˆì‚° ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <button class="btn btn-add" onclick="addExpense()">ì˜ˆì‚° ì¶”ê°€</button>
                
                <div class="category-list" id="expense-list">
                    <div class="category-item">
                        <span class="category-name">ë“±ë¡ëœ ì˜ˆì‚°ì´ ì—†ìŠµë‹ˆë‹¤</span>
                        <span class="category-amount">â‚©0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="total-section">
            <h2>ì˜ˆì‚°</h2>
            <input type="text" id="income-amount" name="save_name" placeholder="ëª©í‘œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.">
            <div style="display: flex; justify-content: space-around; flex-wrap: wrap; margin: 20px 0;">
            	
                <div>
                    <p>ì´ ìˆ˜ì…</p>
                    <div class="total-amount" id="total-income">â‚©0</div>
                </div>
                <div>
                    <p>ì´ ì˜ˆì‚°</p>
                    <div class="total-amount" id="total-expense">â‚©0</div>
                </div>
                <div>
                    <p>ì”ì—¬ ì˜ˆì‚°</p>
                    <div class="total-amount" id="remaining-budget">â‚©0</div>
                </div>
            </div>
        </div>
        <div class="action-buttons">
            <button class="btn btn-save" onclick="saveBudget()">ì˜ˆì‚° ì €ì¥</button>
            <button class="btn btn-reset" onclick="resetBudget()">ì´ˆê¸°í™”</button>
        </div>
	</div>	
</div>
        
	<div th:replace="fragments/footer :: footer"></div>
    <script>
        let incomes = [];
        let expenses = [];

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW'
            }).format(amount);
        }

        function addIncome() {
            const source = document.getElementById('income-source').value;
            const amount = parseInt(document.getElementById('income-amount').value);

            if (!source || !amount || amount <= 0) {
                alert('ìˆ˜ì…ì›ê³¼ ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            incomes.push({ source, amount });
            updateIncomeList();
            updateTotals();
            
            document.getElementById('income-source').value = '';
            document.getElementById('income-amount').value = '';
        }

        function addExpense() {
            const category = document.getElementById('expense-category').value;
            const amount = parseInt(document.getElementById('expense-amount').value);

            if (!category || !amount || amount <= 0) {
                alert('ì¹´í…Œê³ ë¦¬ì™€ ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            expenses.push({ category, amount });
            updateExpenseList();
            updateTotals();
            
            document.getElementById('expense-category').value = '';
            document.getElementById('expense-amount').value = '';
        }

        function updateIncomeList() {
            const list = document.getElementById('income-list');
            
            if (incomes.length === 0) {
                list.innerHTML = '<div class="category-item"><span class="category-name">ë“±ë¡ëœ ìˆ˜ì…ì´ ì—†ìŠµë‹ˆë‹¤</span><span class="category-amount">â‚©0</span></div>';
                return;
            }

            list.innerHTML = incomes.map((income, index) => `
                <div class="category-item">
                    <span class="category-name">${income.source}</span>
                    <div>
                        <span class="category-amount">${formatCurrency(income.amount)}</span>
                        <button class="delete-btn" onclick="removeIncome(${index})">ì‚­ì œ</button>
                    </div>
                </div>
            `).join('');
        }

        function updateExpenseList() {
            const list = document.getElementById('expense-list');
            
            if (expenses.length === 0) {
                list.innerHTML = '<div class="category-item"><span class="category-name">ë“±ë¡ëœ ì˜ˆì‚°ì´ ì—†ìŠµë‹ˆë‹¤</span><span class="category-amount">â‚©0</span></div>';
                return;
            }

            list.innerHTML = expenses.map((expense, index) => `
                <div class="category-item">
                    <span class="category-name">${expense.category}</span>
                    <div>
                        <span class="category-amount">${formatCurrency(expense.amount)}</span>
                        <button class="delete-btn" onclick="removeExpense(${index})">ì‚­ì œ</button>
                    </div>
                </div>
            `).join('');
        }

        function removeIncome(index) {
            incomes.splice(index, 1);
            updateIncomeList();
            updateTotals();
        }

        function removeExpense(index) {
            expenses.splice(index, 1);
            updateExpenseList();
            updateTotals();
        }

        function updateTotals() {
            const totalIncome = incomes.reduce((sum, income) => sum + income.amount, 0);
            const totalExpense = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const remaining = totalIncome - totalExpense;

            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expense').textContent = formatCurrency(totalExpense);
            
            const remainingElement = document.getElementById('remaining-budget');
            remainingElement.textContent = formatCurrency(remaining);
            remainingElement.style.color = remaining >= 0 ? '#2ecc71' : '#e74c3c';
        }

        function saveBudget() {
            if (incomes.length === 0 && expenses.length === 0) {
                alert('ì €ì¥í•  ì˜ˆì‚° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const totalIncome = incomes.reduce((sum, item) => sum + item.amount, 0); // ì´ ìˆ˜ì… ê³„ì‚°

            // 'name="save_name"'ì„ ê°€ì§„ input í•„ë“œì˜ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const saveNameInput = document.querySelector('input[name="save_name"]'); 
            const saveNameValue = saveNameInput ? saveNameInput.value.trim() : '';

            if (saveNameValue === '') {
                alert('ì˜ˆì‚° ëª©í‘œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                if (saveNameInput) {
                    saveNameInput.focus();
                }
                return;
            }

            // â­â˜…â˜… CSRF í† í° ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„ ë‹¤ì‹œ í™•ì¸ ë° ê°•í™” â˜…â˜…â­
            const csrfTokenElement = document.querySelector('input[name="_csrf"]');
            const csrfToken = csrfTokenElement ? csrfTokenElement.value : null;

            // Spring Securityì˜ ê¸°ë³¸ CSRF í—¤ë” ì´ë¦„ì€ 'X-CSRF-TOKEN'ì…ë‹ˆë‹¤.
            // ë§Œì•½ Thymeleafì˜ meta íƒœê·¸ë¡œ `_csrf_header`ë¥¼ ì‚¬ìš©í•œë‹¤ë©´ ê·¸ ê°’ì„ ë”°ë¥´ê³ , ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©.
            const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
            const csrfHeaderName = csrfHeaderMeta ? csrfHeaderMeta.content : 'X-CSRF-TOKEN'; // ê¸°ë³¸ê°’ 'X-CSRF-TOKEN'

            // fetch ìš”ì²­ì— í¬í•¨ë  í—¤ë” ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };

            // CSRF í† í°ì´ ì¡´ì¬í•˜ë©´ í—¤ë”ì— ì¶”ê°€í•©ë‹ˆë‹¤.
            if (csrfToken && csrfHeaderName) {
                headers[csrfHeaderName] = csrfToken; // ë™ì ìœ¼ë¡œ í—¤ë” ì´ë¦„ê³¼ ê°’ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
            } else {
                console.warn("CSRF í† í° ë˜ëŠ” í—¤ë” ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë³´ì•ˆ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            }

            // ì„œë²„ë¡œ ì „ì†¡í•  ë°ì´í„°
            const dataToSend = {
                totalIncome: totalIncome,
                save_name: saveNameValue
            };

            fetch('/consumption/bplannerPro', {
                method: 'POST',
                headers: headers, // â­â˜…â˜… ìˆ˜ì •ëœ headers ê°ì²´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. â˜…â˜…â­
                body: JSON.stringify(dataToSend)
            })
            .then(response => {
                // 403 Forbidden ì—ëŸ¬ë¥¼ íŠ¹ë³„íˆ ì²˜ë¦¬í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ ë¡œê·¸ì¸ í•„ìš” ë“±ì˜ ë©”ì‹œì§€ ì „ë‹¬
                if (response.status === 403) {
                    return response.json().then(errorData => {
                        throw new new Error(errorData.message || 'ì¸ì¦ ì˜¤ë¥˜: ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    }).catch(() => {
                        // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ (ì˜ˆ: HTML ì—ëŸ¬ í˜ì´ì§€ ë°˜í™˜ ì‹œ) ê¸°ë³¸ ë©”ì‹œì§€
                        throw new Error('ì¸ì¦ ì˜¤ë¥˜: ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    });
                }
                if (!response.ok) { // 2xx ì™¸ì˜ ë‹¤ë¥¸ ìƒíƒœ ì½”ë“œ ì²˜ë¦¬
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || 'ì˜ˆì‚° ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
                    });
                }
                return response.json(); // ì„±ê³µì ì¸ 2xx ì‘ë‹µì¸ ê²½ìš° JSON íŒŒì‹±
            })
            .then(data => {
                if (data.success) {
                    alert(data.message + ' ğŸ’¾');
                    window.location.href = '/consumption/canalysis';
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ì˜ˆì‚° ì €ì¥ ì¤‘ ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ê¸°íƒ€ ì˜¤ë¥˜ ë°œìƒ:', error);
                alert('ì˜ˆì‚° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            });
        }

        function resetBudget() {
            if (confirm('ëª¨ë“  ì˜ˆì‚° ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                incomes = [];
                expenses = [];
                updateIncomeList();
                updateExpenseList();
                updateTotals();
                alert('ì˜ˆì‚°ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ”„');
            }
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            updateIncomeList();
            updateExpenseList();
            updateTotals();
        });
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
               window.location.href = '/logout';
            }
         }
    </script>
</body>
</html>