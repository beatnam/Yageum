<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <title>ê°€ê³„ë¶€ ì˜ˆì‚° ì„¤ì •</title>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="../css/common.css">
	<link rel="stylesheet" href="../css/b_planner.css">
	
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body>
<div th:replace="fragments/header :: header"></div>
<div class="app-container">
	
	<div th:replace="fragments/c_sidebar :: c_sidebar"></div>
<input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">


    <div class="container">
    
        <div class="budget-header pulse-animation">
            <h1>ê°€ê³„ë¶€ ì˜ˆì‚° ì„¤ì •</h1>
            <p>í˜„ëª…í•œ ê°€ê³„ ê´€ë¦¬ë¥¼ ìœ„í•œ ì˜ˆì‚° ê³„íšì„ ì„¸ì›Œë³´ì„¸ìš”</p>
        </div>

        <div class="budget-grid">
            <div class="budget-card">
                <h2 class="card-title">ìˆ˜ì… ì„¤ì •</h2>
                <div class="input-group">
                    <label for="income-source">ìˆ˜ì…ì›</label>
                    <select id="income-source">
                        <option value="">ìˆ˜ì…ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="ê¸‰ì—¬">ê¸‰ì—¬</option>
                        <option value="ë¶€ì—…">ë¶€ì—…</option>
                        <option value="íˆ¬ììˆ˜ìµ">íˆ¬ììˆ˜ìµ</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="income-amount-input">ê¸ˆì•¡ (ì›)</label>
                    <input type="number" id="income-amount-input" placeholder="ìˆ˜ì… ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <button class="btn btn-add" onclick="addIncome()">ìˆ˜ì… ì¶”ê°€</button>
                
                <div class="category-list" id="income-list">
                    <div class="category-item no-data" id="no-income-data">
                        <span class="category-name">ë“±ë¡ëœ ìˆ˜ì…ì´ ì—†ìŠµë‹ˆë‹¤</span>
                        <span class="category-amount">â‚©0</span>
                    </div>
                </div>
            </div>

            <div class="budget-card">
                <h2 class="card-title">ì§€ì¶œ ì˜ˆì‚° ì„¤ì •</h2>
                <div class="input-group">
                    <label for="expense-category">ì§€ì¶œ ì¹´í…Œê³ ë¦¬</label>
                    <select id="expense-category">
                        <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="ì‹ë¹„">ì‹ë¹„</option>
                        <option value="êµí†µë¹„">êµí†µë¹„</option>
                        <option value="ì£¼ê±°ë¹„">ì£¼ê±°ë¹„</option>
                        <option value="ì˜ë£Œë¹„">ì˜ë£Œë¹„</option>
                        <option value="êµìœ¡ë¹„">êµìœ¡ë¹„</option>
                        <option value="ì‡¼í•‘">ì‡¼í•‘</option>
                        <option value="ë¬¸í™”ìƒí™œ">ë¬¸í™”ìƒí™œ</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="expense-amount-input">ì˜ˆì‚° ê¸ˆì•¡ (ì›)</label>
                    <input type="number" id="expense-amount-input" placeholder="ì˜ˆì‚° ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <button class="btn btn-add" onclick="addExpense()">ì˜ˆì‚° ì¶”ê°€</button>
                
                <div class="category-list" id="expense-list">
                    <div class="category-item no-data" id="no-expense-data">
                        <span class="category-name">ë“±ë¡ëœ ì˜ˆì‚°ì´ ì—†ìŠµë‹ˆë‹¤</span>
                        <span class="category-amount">â‚©0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="total-section">
            <h2>ì˜ˆì‚° ëª©í‘œëª…</h2>
            <input type="text" id="budget-goal-name" name="save_name" placeholder="ëª©í‘œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.">
            
            <div class="input-group" style="margin-top: 15px;">
                <label for="budget-month-select">ì˜ˆì‚° ì›” ì„ íƒ:</label>
                <select id="budget-month-select" class="form-control"></select>
            </div>
            <div style="display: flex; justify-content: space-around; flex-wrap: wrap; margin: 20px 0;">
            	
                <div>
                    <p>ì´ ìˆ˜ì…</p>
                    <div class="total-amount" id="total-income">â‚©0</div>
                </div>
                <div>
                    <p>ì´ ì˜ˆì‚°</p>
                    <div class="total-amount" id="total-expense">â‚©0</div>
                </div>
                <div>
                    <p>ì”ì—¬ ì˜ˆì‚°</p>
                    <div class="total-amount" id="remaining-budget">â‚©0</div>
                </div>
            </div>
        </div>
        <div class="action-buttons">
            <button class="btn btn-save" onclick="saveBudget()">ì˜ˆì‚° ì €ì¥</button>
            <button class="btn btn-reset" onclick="resetBudget()">ì´ˆê¸°í™”</button>
        </div>
	</div>	
</div>
<div th:replace="fragments/footer :: footer"></div>

    <script th:inline="javascript">
        let incomes = [];
        let expenses = [];

        // CSRF í† í° ë° í—¤ë” ê°€ì ¸ì˜¤ê¸°
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

        if (!csrfToken || !csrfHeader) {
            console.error("CSRF token or header name is missing. AJAX requests might fail.");
            alert("ë³´ì•ˆ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
        }

        function addIncome() {
            const sourceSelect = document.getElementById('income-source');
            const amountInput = document.getElementById('income-amount-input');
            const name = sourceSelect.value;
            const amount = parseInt(amountInput.value);

            if (name && !isNaN(amount) && amount > 0) {
                incomes.push({ name, amount });
                updateIncomeList();
                updateTotals();
                sourceSelect.value = '';
                amountInput.value = '';
            } else {
                alert('ìˆ˜ì…ì›ê³¼ ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        }

        function addExpense() {
            const categorySelect = document.getElementById('expense-category');
            const amountInput = document.getElementById('expense-amount-input');
            const name = categorySelect.value;
            const amount = parseInt(amountInput.value);

            if (name && !isNaN(amount) && amount > 0) {
                expenses.push({ name, amount });
                updateExpenseList();
                updateTotals();
                categorySelect.value = '';
                amountInput.value = '';
            } else {
                alert('ì§€ì¶œ ì¹´í…Œê³ ë¦¬ì™€ ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        }

        function updateIncomeList() {
            const listContainer = document.getElementById('income-list');
            listContainer.innerHTML = '';

            if (incomes.length === 0) {
                const noData = document.createElement('div');
                noData.className = 'category-item no-data';
                noData.innerHTML = `<span class="category-name">ë“±ë¡ëœ ìˆ˜ì…ì´ ì—†ìŠµë‹ˆë‹¤</span><span class="category-amount">â‚©0</span>`;
                listContainer.appendChild(noData);
            } else {
                incomes.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'category-item';
                    div.innerHTML = `<span class="category-name">${item.name}</span><span class="category-amount">â‚©${item.amount.toLocaleString('ko-KR')}</span><button class="delete-btn" onclick="removeIncome(${index})">ì‚­ì œ</button>`;
                    listContainer.appendChild(div);
                });
            }
        }

        function updateExpenseList() {
            const listContainer = document.getElementById('expense-list');
            listContainer.innerHTML = '';

            if (expenses.length === 0) {
                const noData = document.createElement('div');
                noData.className = 'category-item no-data';
                noData.innerHTML = `<span class="category-name">ë“±ë¡ëœ ì˜ˆì‚°ì´ ì—†ìŠµë‹ˆë‹¤</span><span class="category-amount">â‚©0</span>`;
                listContainer.appendChild(noData);
            } else {
                expenses.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'category-item';
                    div.innerHTML = `<span class="category-name">${item.name}</span><span class="category-amount">â‚©${item.amount.toLocaleString('ko-KR')}</span><button class="delete-btn" onclick="removeExpense(${index})">ì‚­ì œ</button>`;
                    listContainer.appendChild(div);
                });
            }
        }

        function removeIncome(index) {
            incomes.splice(index, 1);
            updateIncomeList();
            updateTotals();
        }

        function removeExpense(index) {
            expenses.splice(index, 1);
            updateExpenseList();
            updateTotals();
        }

        function updateTotals() {
            const totalIncome = incomes.reduce((sum, item) => sum + item.amount, 0);
            const totalExpense = expenses.reduce((sum, item) => sum + item.amount, 0);
            const remainingAmount = totalIncome - totalExpense;

            document.getElementById('total-income').textContent = `â‚©${totalIncome.toLocaleString('ko-KR')}`;
            document.getElementById('total-expense').textContent = `â‚©${totalExpense.toLocaleString('ko-KR')}`;
            document.getElementById('remaining-budget').textContent = `â‚©${remainingAmount.toLocaleString('ko-KR')}`;

            if (remainingAmount < 0) {
                document.getElementById('remaining-budget').style.color = 'red';
            } else {
                document.getElementById('remaining-budget').style.color = '#28a745';
            }
        }

        // â­ saveBudget í•¨ìˆ˜ ìˆ˜ì •
	    async function saveBudget() {
	        const budgetNameInput = document.getElementById('budget-goal-name');
	        const budgetName = budgetNameInput.value;
	        
	        const selectedMonth = document.getElementById('budget-month-select').value;
	        if (!selectedMonth) {
	            alert('ì˜ˆì‚° ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
	            return;
	        }
	
	        const [year, month] = selectedMonth.split('-'); // ì´ë¯¸ yearì™€ monthë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤.
	        const firstDayOfMonth = `${year}-${month}-01`;
	        const lastDayOfMonth = `${year}-${month}-${new Date(parseInt(year), parseInt(month), 0).getDate()}`;
	
	        const totalIncome = incomes.reduce((sum, item) => sum + item.amount, 0);
	        const saveAmount = totalIncome; 
	
	        if (!budgetName || incomes.length === 0 || expenses.length === 0) {
	            alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©(ì˜ˆì‚° ëª©í‘œëª…, ìˆ˜ì…/ì§€ì¶œ ëª©ë¡)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
	            return;
	        }
	
	        if (saveAmount <= 0) {
	             alert('ì´ ìˆ˜ì…ì´ 0ì´ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìˆ˜ì…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
	             return;
	        }
	
	        const budgetData = {
	            saveName: budgetName,
	            saveCreatedDate: firstDayOfMonth, 
	            saveTargetDate: lastDayOfMonth,
	            saveAmount: saveAmount
	        };
	
	        let shouldProceedToSave = true;
	
	        try {
	            // 1. ì„ íƒëœ ì›”ì˜ ì˜ˆì‚° ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
	            // â­ ì´ ë¶€ë¶„ì„ ìˆ˜ì •í•©ë‹ˆë‹¤: monthì™€ year íŒŒë¼ë¯¸í„°ë¥¼ ì „ë‹¬í•˜ë„ë¡
	            const checkUrl = `/consumption/hasSavingsPlanForMonth?month=${parseInt(month)}&year=${parseInt(year)}`;
	            
	            const checkResponse = await fetch(checkUrl, {
	                method: 'GET',
	                headers: {
	                    [csrfHeader]: csrfToken
	                }
	            });
	
	            if (!checkResponse.ok) {
	                if (checkResponse.status === 403) {
	                     throw new Error('ì¸ì¦ ì˜¤ë¥˜: ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
	                }
	                const errorResult = await checkResponse.json().catch(() => {
	                    return checkResponse.text().then(text => ({ message: text || 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜' }));
	                });
	                throw new Error(errorResult.message || `ì˜ˆì‚° ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ì‹¤íŒ¨: ${checkResponse.status} ${checkResponse.statusText}`);
	            }
	            const checkResult = await checkResponse.json();
	
	            if (checkResult.exists) {
	                const confirmOverwrite = confirm("ì„ íƒí•˜ì‹  ì›”ì— ì €ì¥ëœ ì˜ˆì‚°ì´ ìˆìŠµë‹ˆë‹¤. í˜„ì¬ ë‚´ìš©ìœ¼ë¡œ ì—…ë°ì´íŠ¸ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n'ì˜ˆ'ë¥¼ ëˆ„ë¥´ë©´ ì—…ë°ì´íŠ¸ë˜ê³ , 'ì•„ë‹ˆì˜¤'ë¥¼ ëˆ„ë¥´ë©´ ì €ì¥ ì—†ì´ ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
	                if (!confirmOverwrite) {
	                    shouldProceedToSave = false;
	                }
	            }
	
	            if (shouldProceedToSave) {
	                // 2. ì˜ˆì‚° ì €ì¥/ì—…ë°ì´íŠ¸ API í˜¸ì¶œ
	                const saveUrl = '/consumption/bplannerPro';
	                const saveResponse = await fetch(saveUrl, {
	                    method: 'POST',
	                    headers: {
	                        'Content-Type': 'application/json',
	                        [csrfHeader]: csrfToken
	                    },
	                    body: JSON.stringify(budgetData)
	                });
	
	                if (!saveResponse.ok) {
	                    if (saveResponse.status === 403) {
	                        throw new Error('ì¸ì¦ ì˜¤ë¥˜: ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
	                    }
	                    const errorResult = await saveResponse.json().catch(() => {
	                        return saveResponse.text().then(text => ({ message: text || 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜' }));
	                    });
	                    throw new Error(errorResult.message || `ì˜ˆì‚° ì €ì¥/ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${saveResponse.status}`);
	                }
	
	                const result = await saveResponse.json();
	                if (result.success) {
	                    alert(result.message + ' ğŸ’¾');
	                    if (confirm('ì†Œë¹„ë¶„ì„ í˜ì´ì§€ë¡œ ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
	                        window.location.href = '/consumption/efeedback';
	                    }
	                } else {
	                    alert('ì €ì¥ ì‹¤íŒ¨: ' + result.message);
	                }
	            } else {
	                console.log("ì˜ˆì‚° ì €ì¥ì„ ì·¨ì†Œí•˜ê³  ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
	            }
	
	            if (!shouldProceedToSave) {
	                if (confirm('ì €ì¥ ì—†ì´ ì†Œë¹„ë¶„ì„ í˜ì´ì§€ë¡œ ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
	                    window.location.href = '/consumption/efeedback';
	                }
	            }
	
	        } catch (error) {
	            console.error('ì˜ˆì‚° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
	            alert('ì˜ˆì‚° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
	        }
	    }

        function resetBudget() {
            if (confirm('ëª¨ë“  ì˜ˆì‚° ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í˜„ì¬ í˜ì´ì§€ì˜ ë°ì´í„°ë§Œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.)')) {
                incomes = [];
                expenses = [];
                document.getElementById('budget-goal-name').value = '';
                // ì›” ì„ íƒê¸°ëŠ” í˜„ì¬ ê°’ ìœ ì§€ (ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ)
                updateIncomeList();
                updateExpenseList();
                updateTotals();
                alert('ì˜ˆì‚° ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ”„');
            }
        }

        // â­ ì›” ì„ íƒê¸° ì±„ìš°ê¸° í•¨ìˆ˜ ì¶”ê°€
        function populateMonthSelect() {
            const select = document.getElementById('budget-month-select');
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth(); // 0-11

            // í˜„ì¬ ë…„ë„ ê¸°ì¤€ìœ¼ë¡œ ì´ì „ 2ë…„, í˜„ì¬ ë…„ë„, ì´í›„ 2ë…„ê¹Œì§€ í‘œì‹œ
            const startYear = currentYear - 2;
            const endYear = currentYear + 2;

            for (let year = startYear; year <= endYear; year++) {
                for (let month = 0; month < 12; month++) {
                    const date = new Date(year, month, 1);
                    const optionValue = `${year}-${String(month + 1).padStart(2, '0')}`;
                    const optionText = `${year}ë…„ ${String(month + 1).padStart(2, '0')}ì›”`;
                    
                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = optionText;

                    // í˜„ì¬ ì›”ì„ ê¸°ë³¸ ì„ íƒê°’ìœ¼ë¡œ ì„¤ì •
                    if (year === currentYear && month === currentMonth) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                }
            }
        }

        // â­ ì„ íƒëœ ì›”ì˜ ì˜ˆì‚° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜ ì¶”ê°€
	    async function loadBudgetForSelectedMonth() {
	        const selectedMonth = document.getElementById('budget-month-select').value;
	        if (!selectedMonth) {
	            return;
	        }
	
	        const [year, month] = selectedMonth.split('-');
	        // const firstDayOfMonth = `${year}-${month}-01`; // ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
	        // const lastDayOfMonth = `${year}-${month}-${new Date(parseInt(year), parseInt(month), 0).getDate()}`; // ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
	
	        // â­ ì´ ë¶€ë¶„ì„ ìˆ˜ì •í•©ë‹ˆë‹¤: monthì™€ year íŒŒë¼ë¯¸í„°ë¥¼ ì „ë‹¬í•˜ë„ë¡
	        // ì»¨íŠ¸ë¡¤ëŸ¬ì˜ getSavingsPlanForMonthëŠ” startOfMonth, endOfMonthë¥¼ ë°›ìœ¼ë¯€ë¡œ,
	        // ì´ ë¶€ë¶„ì€ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ getSavingsPlanForMonthê°€ monthì™€ yearë¥¼ ë°›ë„ë¡ ë³€ê²½í•˜ê±°ë‚˜,
	        // ì•„ë‹ˆë©´ ì—¬ê¸°ì„œ firstDayOfMonthì™€ lastDayOfMonthë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê²¨ì•¼ í•©ë‹ˆë‹¤.
	        // í˜„ì¬ ì œê°€ ì§€ë‚œë²ˆì— ì œê³µí•´ë“œë¦° Controllerì˜ getSavingsPlanForMonthëŠ” ì›”, ì¼ì„ ë°›ë„ë¡ ë˜ì–´ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.
	        // Controllerì˜ getSavingsPlanForMonthëŠ” mapí˜•íƒœë¡œ ë˜ì–´ìˆëŠ”ë° ê·¸ê±¸ ì§€ê¸ˆ ë°”ê¿”ì£¼ëŠ”ê²Œ ë” ë¹ ë¥¼ ê²ƒ ê°™ì•„
	        // ê¸°ì¡´ Controller ì½”ë“œë¥¼ ë‹¤ì‹œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.
	
	        // â­ ì ê¹, Confusion!
	        // ì œê°€ ë°©ê¸ˆ ì „ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ `hasSavingsPlanForMonth`ë¥¼ `month`ì™€ `year`ë¡œ ë°›ë„ë¡ ìˆ˜ì •í•˜ë¼ê³  í–ˆìŠµë‹ˆë‹¤.
	        // ê·¸ëŸ°ë° `loadBudgetForSelectedMonth`ëŠ” `getSavingsPlanForMonth` APIë¥¼ í˜¸ì¶œí•˜ëŠ”ë°,
	        // ì œê°€ ì œê³µí–ˆë˜ `ConsumptionController`ì˜ `getSavingsPlanForMonth`ëŠ” `startOfMonth`ì™€ `endOfMonth`ë¥¼ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ë°›ìŠµë‹ˆë‹¤.
	        // ì¦‰, ì»¨íŠ¸ë¡¤ëŸ¬ì˜ `getSavingsPlanForMonth`ëŠ”:
	        // `@GetMapping("/getSavingsPlanForMonth")`
	        // `public ResponseEntity<Map<String, Object>> getSavingsPlanForMonth(@RequestParam("startOfMonth") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startOfMonth, @RequestParam("endOfMonth") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endOfMonth, ...)`
	        // ë¡œ ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
	
	        // `hasSavingsPlanForMonth`ëŠ” `month`ì™€ `year`ë¥¼ ë°›ë„ë¡ ìˆ˜ì •í–ˆì§€ë§Œ,
	        // `getSavingsPlanForMonth`ëŠ” ì—¬ì „íˆ `startOfMonth`ì™€ `endOfMonth`ë¥¼ ë°›ëŠ” ê²ƒì´ ë§ìŠµë‹ˆë‹¤.
	        // ë”°ë¼ì„œ `loadBudgetForSelectedMonth`ì˜ `loadUrl`ì€ ë³€ê²½í•˜ì§€ ì•Šê³  ìœ ì§€í•˜ëŠ” ê²ƒì´ ë§ìŠµë‹ˆë‹¤.
	
	        // ë‹¤ì‹œ ì •ë¦¬í•˜ë©´:
	        // 1. `saveBudget` í•¨ìˆ˜ ì•ˆì˜ `checkUrl`ì€ `/consumption/hasSavingsPlanForMonth?month=${parseInt(month)}&year=${parseInt(year)}` ë¡œ ìˆ˜ì •. (ì´ì „ ë‹µë³€ì—ì„œ ì´ ë¶€ë¶„ì„ ì¤‘ì ì ìœ¼ë¡œ ì„¤ëª…í–ˆìŠµë‹ˆë‹¤.)
	        // 2. `loadBudgetForSelectedMonth` í•¨ìˆ˜ ì•ˆì˜ `loadUrl`ì€ ê·¸ëŒ€ë¡œ ìœ ì§€. (`/consumption/getSavingsPlanForMonth?startOfMonth=${firstDayOfMonth}&endOfMonth=${lastDayOfMonth}`)
	        //    (ì´ëŠ” `ConsumptionController`ì— `getSavingsPlanForMonth`ê°€ `startOfMonth`, `endOfMonth`ë¥¼ `@RequestParam`ìœ¼ë¡œ ë°›ëŠ”ë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.)
	
	        const loadUrl = `/consumption/getSavingsPlanForMonth?startOfMonth=${firstDayOfMonth}&endOfMonth=${lastDayOfMonth}`; // â­ ì´ ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.
	
	        try {
	            const response = await fetch(loadUrl, {
	                method: 'GET',
	                headers: {
	                    [csrfHeader]: csrfToken
	                }
	            });
	
	            if (!response.ok) {
	                 if (response.status === 404) {
	                     console.log("ì„ íƒëœ ì›”ì— ì €ì¥ëœ ì˜ˆì‚°ì´ ì—†ìŠµë‹ˆë‹¤.");
	                     incomes = [];
	                     expenses = [];
	                     document.getElementById('budget-goal-name').value = '';
	                     updateIncomeList();
	                     updateExpenseList();
	                     updateTotals();
	                     return;
	                 }
	                if (response.status === 403) {
	                     throw new Error('ì¸ì¦ ì˜¤ë¥˜: ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
	                }
	                const errorResult = await response.json().catch(() => {
	                    return response.text().then(text => ({ message: text || 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜' }));
	                });
	                throw new Error(errorResult.message || `ì˜ˆì‚° ë¡œë“œ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
	            }
	
	            const data = await response.json();
	            
	            // ... (ë‚˜ë¨¸ì§€ loadBudgetForSelectedMonth í•¨ìˆ˜ ë‚´ìš© ìœ ì§€) ...
	            
	        } catch (error) {
	            console.error('ì˜ˆì‚° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
	            alert('ì˜ˆì‚° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
	        }
	    }


        document.addEventListener('DOMContentLoaded', function() {
            populateMonthSelect(); // ì›” ì„ íƒê¸° ì±„ìš°ê¸° í˜¸ì¶œ
            // í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ì„ íƒëœ ì›”ì˜ ì˜ˆì‚° ë°ì´í„° ë¡œë“œ
            loadBudgetForSelectedMonth(); 
            
            // ì›” ì„ íƒê¸°ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ í•´ë‹¹ ì›”ì˜ ì˜ˆì‚° ë°ì´í„° ë¡œë“œ
            document.getElementById('budget-month-select').addEventListener('change', loadBudgetForSelectedMonth);

            updateIncomeList(); // ì´ˆê¸°í™” í›„ ëª©ë¡ ì—…ë°ì´íŠ¸ (ì´ˆê¸°ì—ëŠ” ë¹„ì–´ìˆìŒ)
            updateExpenseList(); // ì´ˆê¸°í™” í›„ ëª©ë¡ ì—…ë°ì´íŠ¸ (ì´ˆê¸°ì—ëŠ” ë¹„ì–´ìˆìŒ)
            updateTotals(); // ì´ˆê¸°í™” í›„ ì´ê³„ ì—…ë°ì´íŠ¸ (ì´ˆê¸°ì—ëŠ” 0)
        });
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
               window.location.href = '/logout';
            }
         }
    </script>
</body>
</html>