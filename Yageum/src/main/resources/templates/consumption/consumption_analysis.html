<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>소비분석 종합결과</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="../css/c_analysis.css">
	<link rel="stylesheet" href="../css/common.css">

</head>
<body>
<div th:replace="fragments/header :: header"></div>
<div class="app-container">
	
	<div th:replace="fragments/c_sidebar :: c_sidebar"></div>
<input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">


        <div class="main-wrapper">
            <div class="container">
            
                <div class="header">
				    <h1>💰 소비분석 종합결과</h1>
				    <p th:text="|${#dates.format(#dates.createNow(), 'yyyy년 MM월')} 기준 • 개인 소비 패턴 분석 리포트|">2024년 12월 기준 • 개인 소비 패턴 분석 리포트</p>
				</div>
				
				<div class="stats-grid">
				    <div class="stat-card">
				        <div class="stat-number">
				            <span th:if="${totalExpense != 0}" th:text="${#numbers.formatCurrency(totalExpense)}">₩2,450,000</span>
				            <span th:unless="${totalExpense != 0}">데이터 없음</span>
				        </div>
				        <div class="stat-label">이번 달 총 지출</div>
				        </div>
				    <div class="stat-card">
				        <div class="stat-number">
				            <span th:if="${averageDailyExpense != 0}" th:text="${#numbers.formatCurrency(averageDailyExpense)}">₩98,000</span>
				            <span th:unless="${averageDailyExpense != 0}">데이터 없음</span>
				        </div>
				        <div class="stat-label">일평균 지출</div>
				        </div>
				    <div class="stat-card">
				        <div class="stat-number">
				            <span th:if="${countThisMonth != 0}" th:text="${#numbers.formatInteger(countThisMonth, 0, 'COMMA')}">156</span>
				            <span th:unless="${countThisMonth != 0}">데이터 없음</span>
				        </div>
				        <div class="stat-label">총 지출 건수</div>
				        </div>
				    <div class="stat-card">
				        <div class="stat-number">
				            <span th:if="${remainingBudget != 0}" th:text="${#numbers.formatCurrency(remainingBudget)}">₩750,000</span>
				            <span th:unless="${remainingBudget != 0}">데이터 없음</span>
				        </div>
				        <div class="stat-label">이번 달 남은 금액</div>
				        </div>
				</div>

                <div class="main-content">
                    <div class="chart-section">
                        <h2 class="section-title">📊 카테고리별 지출</h2>
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>

                    <div class="insights-section">
                        <h2 class="section-title">💡 소비 분석 종합 결과 및 주요 인사이트</h2>
                        <div id="categoryAnalysisInsightsHidden" th:text="${categoryAnalysisInsights}" style="display: none;"></div>
                        
                        <div id="categoryAnalysisOutput" class="analysis-content">
                            </div>
                    </div>
                    </div>

                <div class="ai-feedback-section">
                    <h2 class="section-title">✨ AI 소비 분석 피드백</h2>
                    <p class="section-description">월별 지출 및 카테고리별 지출 데이터를 기반으로 AI가 맞춤형 소비 피드백을 제공합니다.</p>
                    
                    <div class="feedback-status">
                        <div id="feedbackLoading" style="display: none; color: #007bff; margin-top: 10px;">분석 중... 잠시만 기다려주세요.</div>
                        <div id="feedbackError" style="display: none; color: red; margin-top: 10px;">피드백을 가져오는 데 실패했습니다. 다시 시도해주세요.</div>
                    </div>

                    <div class="ai-feedback-output" id="aiFeedbackOutput">
                        <p style="color: #666; margin-top: 20px;">AI가 소비 데이터를 분석하여 맞춤형 피드백을 생성 중입니다.</p>
                    </div>
                </div>
            </div>
        </div>
</div>

	<div th:replace="fragments/footer :: footer"></div>

    <script th:inline="javascript">
	    document.querySelectorAll('.stat-card, .category-item').forEach(card => {
	        card.addEventListener('mouseenter', function() {
	            this.style.transform = 'translateY(-10px) scale(1.02)';
	        });
	        
	        card.addEventListener('mouseleave', function() {
	            this.style.transform = 'translateY(0) scale(1)';
	        });
	    });

	    function logout() {
	        if (confirm('로그아웃 하시겠습니까?')) {
	           window.location.href = '/logout';
	        }
	     }
	    const categoryExpenses = /*[[${categoryExpenses}]]*/ [];
	    const labels = [];
	    const data = [];
	    const backgroundColors = [];
	    const colorPalette = [
	        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
	        '#FF9F40', '#E7E9ED', '#C9CBCE', '#A7AEB8', '#868B94',
	        '#6B6B6B', '#FFD700', '#ADFF2F', '#8A2BE2', '#D2691E'
	    ];

	    categoryExpenses.forEach((item, index) => {
	        labels.push(item.categoryName);
	        data.push(Number(item.amount));
	        backgroundColors.push(colorPalette[index % colorPalette.length]);
	    });
		
	    console.log("Labels for Chart:", labels);
	    console.log("Data for Chart (amounts):", data);
	    console.log("Data length:", data.length);
	    console.log("Are all data values zero?", data.every(amount => amount === 0));
		
	    if (data.length === 0 || data.every(amount => amount === 0)) {
	        const chartContainer = document.querySelector('.chart-container');
	        if (chartContainer) {
	            chartContainer.innerHTML = '<p style="text-align:center; padding: 20px; color: #555;">데이터가 없습니다. 지출을 기록해주세요!</p>';
	            chartContainer.style.display = 'flex';
	            chartContainer.style.alignItems = 'center';
	            chartContainer.style.justifyContent = 'center';
	            chartContainer.style.minHeight = '200px';
	        }
	    } else {
	        const ctx = document.getElementById('categoryChart').getContext('2d');
	        const categoryChart = new Chart(ctx, {
	            type: 'pie',
	            data: {
	                labels: labels,
	                datasets: [{
	                    data: data,
	                    backgroundColor: backgroundColors,
	                    hoverOffset: 4
	                }]
	            },
	            options: {
	                responsive: true,
	                plugins: {
	                    legend: {
	                        position: 'right',
	                    },
	                    tooltip: {
	                        callbacks: {
	                            label: function(context) {
	                                let label = context.label || '';
	                                if (label) {
	                                    label += ': ';
	                                }
	                                const value = context.parsed;
	                                label += '₩' + value.toLocaleString('ko-KR');
	                                return label;
	                            },
	                            afterLabel: function(context) {
	                                const sum = context.dataset.data.reduce((a, b) => a + b, 0);
	                                const currentValue = context.parsed;
	                                const percentage = parseFloat((currentValue / sum * 100).toFixed(1));
	                                return `(${percentage}%)`;
	                            }
	                        }
	                    }
	                }
	            }
	        });
	    }
	    function animateNumbers() {
	        document.querySelectorAll('.stat-number').forEach(element => {
	            const textContent = element.textContent;
	            let number = parseInt(textContent.replace('₩', '').replace(/,/g, ''));
	            if (isNaN(number) || number === 0) {
	                return;
	            }
	            let current = 0;
	            const duration = 1000;
	            let startTime = null;
	
	            function easeOutQuad(t) {
	                return t * (2 - t);
	            }
	            function animate(currentTime) {
	                if (!startTime) startTime = currentTime;
	                const progress = (currentTime - startTime) / duration;
	                const easedProgress = easeOutQuad(Math.min(progress, 1));
	                const animatedValue = Math.floor(easedProgress * number);
	                element.textContent = '₩' + animatedValue.toLocaleString('ko-KR');
	
	                if (progress < 1) {
	                    requestAnimationFrame(animate);
	                } else {
	                    element.textContent = textContent;
	                }
	            }
	            requestAnimationFrame(animate);
	        });
	    }
	    window.addEventListener('load', function() {
	        animateNumbers();
	    });
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const markdownTextElement = document.getElementById('categoryAnalysisInsightsHidden');
            if (markdownTextElement) {
                const markdownText = markdownTextElement.textContent;
                const htmlOutput = marked.parse(markdownText);
                const outputElement = document.getElementById('categoryAnalysisOutput');
                if (outputElement) {
                    outputElement.innerHTML = htmlOutput;
                }
            }
            fetchAiFeedback();
        });

        function fetchAiFeedback() {
            const aiFeedbackOutput = document.getElementById('aiFeedbackOutput');
            const feedbackLoading = document.getElementById('feedbackLoading');
            const feedbackError = document.getElementById('feedbackError');

            const csrfHeader = 'X-CSRF-TOKEN';
            let csrfToken = /*[[${_csrf?.token}]]*/ ''; 
            
            if (!csrfToken || csrfToken === '') {
                 const hiddenCsrfInput = document.querySelector('input[name="_csrf"]'); 
                 if (hiddenCsrfInput) {
                     csrfToken = hiddenCsrfInput.value;
                 }
            }
            aiFeedbackOutput.innerHTML = '<p style="color: #666; margin-top: 20px;">AI가 소비 데이터를 분석하여 맞춤형 피드백을 생성 중입니다.</p>';
            feedbackLoading.style.display = 'block'; 
            feedbackError.style.display = 'none';    

            $.ajax({
                url: "/consumption/getChatGptFeedbackForCanalysis",
                type: "GET",
                beforeSend: function(xhr) {
                    if (csrfHeader && csrfHeader !== '' && csrfToken && csrfToken !== '') {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    } else {
                        console.warn("CSRF token or header name is missing. Request might fail.");
                    }
                },
                success: function(response) {
                    feedbackLoading.style.display = 'none';
                    if (response.error) {
                        feedbackError.style.display = 'block'; 
                        aiFeedbackOutput.innerHTML = '<p style="color: red; margin-top: 20px;">오류: ' + response.error + '</p>';
                    } else if (response.feedback) {
                        aiFeedbackOutput.innerHTML = marked.parse(response.feedback);
                    } else {
                        aiFeedbackOutput.innerHTML = '<p style="color: #666; margin-top: 20px;">AI 피드백을 받아오지 못했습니다.</p>';
                    }
                },
                error: function(xhr, status, error) {
                    feedbackLoading.style.display = 'none'; 
                    feedbackError.style.display = 'block';   
                    console.error("AJAX Error:", status, error, xhr.responseText);
                    aiFeedbackOutput.innerHTML = '<p style="color: red; margin-top: 20px;">피드백을 가져오는 중 네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p>';
                }
            });
        }
    </script>
</body>
</html>