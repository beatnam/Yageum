<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>소비분석 종합결과</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="../css/c_analysis.css">
	<link rel="stylesheet" href="../css/common.css">

</head>
<body>
<div th:replace="fragments/header :: header"></div>
<div class="app-container">
	
	<div th:replace="fragments/c_sidebar :: c_sidebar"></div>
<input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">



        <div class="main-wrapper">
            <div class="container">
            
                <div class="header">
				    <h1>💰 소비분석 종합결과</h1>
				    <p th:text="|${#dates.format(#dates.createNow(), 'yyyy년 MM월')} 기준 • 개인 소비 패턴 분석 리포트|">2024년 12월 기준 • 개인 소비 패턴 분석 리포트</p>
				</div>
				
				<div class="stats-grid">
				    <div class="stat-card">
				        <div class="stat-number">
				            <span th:if="${totalExpense != 0}" th:text="${#numbers.formatCurrency(totalExpense)}">₩2,450,000</span>
				            <span th:unless="${totalExpense != 0}">데이터 없음</span>
				        </div>
				        <div class="stat-label">이번 달 총 지출</div>
				        </div>
				    <div class="stat-card">
				        <div class="stat-number">
				            <span th:if="${averageDailyExpense != 0}" th:text="${#numbers.formatCurrency(averageDailyExpense)}">₩98,000</span>
				            <span th:unless="${averageDailyExpense != 0}">데이터 없음</span>
				        </div>
				        <div class="stat-label">일평균 지출</div>
				        </div>
				    <div class="stat-card">
				        <div class="stat-number">
				            <span th:if="${countThisMonth != 0}" th:text="${#numbers.formatInteger(countThisMonth, 0, 'COMMA')}">156</span>
				            <span th:unless="${countThisMonth != 0}">데이터 없음</span>
				        </div>
				        <div class="stat-label">총 거래 건수</div>
				        </div>
				    <div class="stat-card">
				        <div class="stat-number">
				            <span th:if="${remainingBudget != 0}" th:text="${#numbers.formatCurrency(remainingBudget)}">₩750,000</span>
				            <span th:unless="${remainingBudget != 0}">데이터 없음</span>
				        </div>
				        <div class="stat-label">이번 달 남은 금액</div>
				        </div>
				</div>

                <div class="main-content">
                    <div class="chart-section">
                        <h2 class="section-title">📊 카테고리별 지출</h2>
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>

                    <div class="insights-section">
                        <h2 class="section-title">💡 주요 인사이트</h2>
                        <div class="insight-item">
                            <div class="insight-title">절약 성공</div>
                            <div class="insight-text">이번 달 식비 지출이 목표 대비 15% 절약되었습니다.</div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-title">지출 패턴 변화</div>
                            <div class="insight-text">온라인 쇼핑 비중이 전월 대비 25% 증가했습니다.</div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-title">추천 개선사항</div>
                            <div class="insight-text">카페 지출을 월 50만원으로 제한하면 연간 120만원 절약 가능합니다.</div>
                        </div>
                    </div>
                </div>

                <div class="categories-section">
                    <h2 class="section-title">🏷️ 카테고리별 지출 현황</h2>
                    <div class="category-grid">
                        <div class="category-item">
                            <div class="category-icon">🍽️</div>
                            <div class="category-name">식비</div>
                            <div class="category-amount">₩680,000</div>
                        </div>
                        <div class="category-item">
                            <div class="category-icon">🚗</div>
                            <div class="category-name">교통비</div>
                            <div class="category-amount">₩240,000</div>
                        </div>
                        <div class="category-item">
                            <div class="category-icon">🛍️</div>
                            <div class="category-name">쇼핑</div>
                            <div class="category-amount">₩420,000</div>
                        </div>
                        <div class="category-item">
                            <div class="category-icon">🎬</div>
                            <div class="category-name">문화생활</div>
                            <div class="category-amount">₩180,000</div>
                        </div>
                        <div class="category-item">
                            <div class="category-icon">☕</div>
                            <div class="category-name">카페</div>
                            <div class="category-amount">₩320,000</div>
                        </div>
                        <div class="category-item">
                            <div class="category-icon">💊</div>
                            <div class="category-name">의료/건강</div>
                            <div class="category-amount">₩110,000</div>
                        </div>
                    </div>
                </div>

                <div class="footer">
                    <p>📈 스마트한 소비 관리로 더 나은 미래를 만들어보세요</p>
                    <p style="margin-top: 10px; font-size: 0.8rem; opacity: 0.7;">
                        데이터 업데이트: 2024.12.31 | 분석 기간: 2024.12.01 - 2024.12.31
                    </p>
                </div>
            </div>
        </div>
</div>

	<div th:replace="fragments/footer :: footer"></div>

    <script th:inline="javascript">
	    document.querySelectorAll('.stat-card, .category-item').forEach(card => {
	        card.addEventListener('mouseenter', function() {
	            this.style.transform = 'translateY(-10px) scale(1.02)';
	        });
	        
	        card.addEventListener('mouseleave', function() {
	            this.style.transform = 'translateY(0) scale(1)';
	        });
	    });
		
	    document.querySelectorAll('.insight-item').forEach(item => {
	        item.addEventListener('click', function() {
	            this.style.backgroundColor = '#fdcb6e';
	            setTimeout(() => {
	                this.style.backgroundColor = '';
	            }, 200);
	        });
	    });
	    function logout() {
	        if (confirm('로그아웃 하시겠습니까?')) {
	           window.location.href = '/logout';
	        }
	     }
	    const categoryExpenses = /*[[${categoryExpenses}]]*/ [];
	    const labels = [];
	    const data = [];
	    const backgroundColors = [];
	    const colorPalette = [
	        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
	        '#FF9F40', '#E7E9ED', '#C9CBCE', '#A7AEB8', '#868B94',
	        '#6B6B6B', '#FFD700', '#ADFF2F', '#8A2BE2', '#D2691E'
	    ];

	    categoryExpenses.forEach((item, index) => {
	        labels.push(item.categoryName);
	        data.push(Number(item.amount));
	        backgroundColors.push(colorPalette[index % colorPalette.length]);
	    });
		
	    console.log("Labels for Chart:", labels);
	    console.log("Data for Chart (amounts):", data);
	    console.log("Data length:", data.length);
	    console.log("Are all data values zero?", data.every(amount => amount === 0));
		
	    if (data.length === 0 || data.every(amount => amount === 0)) {
	        const chartContainer = document.querySelector('.chart-container');
	        if (chartContainer) {
	            chartContainer.innerHTML = '<p style="text-align:center; padding: 20px; color: #555;">데이터가 없습니다. 지출을 기록해주세요!</p>';
	            chartContainer.style.display = 'flex';
	            chartContainer.style.alignItems = 'center';
	            chartContainer.style.justifyContent = 'center';
	            chartContainer.style.minHeight = '200px';
	        }
	    } else {
	        const ctx = document.getElementById('categoryChart').getContext('2d');
	        const categoryChart = new Chart(ctx, {
	            type: 'pie',
	            data: {
	                labels: labels,
	                datasets: [{
	                    data: data,
	                    backgroundColor: backgroundColors,
	                    hoverOffset: 4
	                }]
	            },
	            options: {
	                responsive: true,
	                plugins: {
	                    legend: {
	                        position: 'right',
	                    },
	                    tooltip: {
	                        callbacks: {
	                            label: function(context) {
	                                let label = context.label || '';
	                                if (label) {
	                                    label += ': ';
	                                }
	                                const value = context.parsed;
	                                label += '₩' + value.toLocaleString('ko-KR');
	                                return label;
	                            },
	                            afterLabel: function(context) {
	                                const sum = context.dataset.data.reduce((a, b) => a + b, 0);
	                                const currentValue = context.parsed;
	                                const percentage = parseFloat((currentValue / sum * 100).toFixed(1));
	                                return `(${percentage}%)`;
	                            }
	                        }
	                    }
	                }
	            }
	        });
	    }
	    function animateNumbers() {
	        document.querySelectorAll('.stat-number').forEach(element => {
	            const textContent = element.textContent;
	            let number = parseInt(textContent.replace('₩', '').replace(/,/g, ''));
	            if (isNaN(number) || number === 0) {
	                return;
	            }
	            let current = 0;
	            const duration = 1000;
	            let startTime = null;
	
	            function easeOutQuad(t) {
	                return t * (2 - t);
	            }
	            function animate(currentTime) {
	                if (!startTime) startTime = currentTime;
	                const progress = (currentTime - startTime) / duration;
	                const easedProgress = easeOutQuad(Math.min(progress, 1));
	                const animatedValue = Math.floor(easedProgress * number);
	                element.textContent = '₩' + animatedValue.toLocaleString('ko-KR');
	
	                if (progress < 1) {
	                    requestAnimationFrame(animate);
	                } else {
	                    element.textContent = textContent;
	                }
	            }
	            requestAnimationFrame(animate);
	        });
	    }
	    window.addEventListener('load', function() {
	        animateNumbers();
	    });
    </script>
</body>
</html>