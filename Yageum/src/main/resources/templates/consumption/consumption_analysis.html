<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œë¹„ë¶„ì„ ì¢…í•©ê²°ê³¼</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="../css/c_analysis.css">
	<link rel="stylesheet" href="../css/common.css">

</head>
<body>
<div th:replace="fragments/header :: header"></div>
<div class="app-container">
	
	<div th:replace="fragments/c_sidebar :: c_sidebar"></div>
<input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">


        <div class="main-wrapper">
            <div class="container">
            
                <div class="header">
				    <h1>ğŸ’° ì†Œë¹„ë¶„ì„ ì¢…í•©ê²°ê³¼</h1>
				    <p th:text="|${#dates.format(#dates.createNow(), 'yyyyë…„ MMì›”')} ê¸°ì¤€ â€¢ ê°œì¸ ì†Œë¹„ íŒ¨í„´ ë¶„ì„ ë¦¬í¬íŠ¸|">2024ë…„ 12ì›” ê¸°ì¤€ â€¢ ê°œì¸ ì†Œë¹„ íŒ¨í„´ ë¶„ì„ ë¦¬í¬íŠ¸</p>
				</div>
				
				<div class="stats-grid">
				    <div class="stat-card">
				        <div class="stat-number">
				            <span th:if="${totalExpense != 0}" th:text="${#numbers.formatCurrency(totalExpense)}">â‚©2,450,000</span>
				            <span th:unless="${totalExpense != 0}">ë°ì´í„° ì—†ìŒ</span>
				        </div>
				        <div class="stat-label">ì´ë²ˆ ë‹¬ ì´ ì§€ì¶œ</div>
				        </div>
				    <div class="stat-card">
				        <div class="stat-number">
				            <span th:if="${averageDailyExpense != 0}" th:text="${#numbers.formatCurrency(averageDailyExpense)}">â‚©98,000</span>
				            <span th:unless="${averageDailyExpense != 0}">ë°ì´í„° ì—†ìŒ</span>
				        </div>
				        <div class="stat-label">ì¼í‰ê·  ì§€ì¶œ</div>
				        </div>
				    <div class="stat-card">
				        <div class="stat-number">
				            <span th:if="${countThisMonth != 0}" th:text="${#numbers.formatInteger(countThisMonth, 0, 'COMMA')}">156</span>
				            <span th:unless="${countThisMonth != 0}">ë°ì´í„° ì—†ìŒ</span>
				        </div>
				        <div class="stat-label">ì´ ì§€ì¶œ ê±´ìˆ˜</div>
				        </div>
				    <div class="stat-card">
				        <div class="stat-number">
				            <span th:if="${remainingBudget != 0}" th:text="${#numbers.formatCurrency(remainingBudget)}">â‚©750,000</span>
				            <span th:unless="${remainingBudget != 0}">ë°ì´í„° ì—†ìŒ</span>
				        </div>
				        <div class="stat-label">ì´ë²ˆ ë‹¬ ë‚¨ì€ ê¸ˆì•¡</div>
				        </div>
				</div>

                <div class="main-content">
                    <div class="chart-section">
                        <h2 class="section-title">ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</h2>
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>

                    <div class="insights-section">
                        <h2 class="section-title">ğŸ’¡ ì†Œë¹„ ë¶„ì„ ì¢…í•© ê²°ê³¼ ë° ì£¼ìš” ì¸ì‚¬ì´íŠ¸</h2>
                        <div id="categoryAnalysisInsightsHidden" th:text="${categoryAnalysisInsights}" style="display: none;"></div>
                        
                        <div id="categoryAnalysisOutput" class="analysis-content">
                            </div>
                    </div>
                    </div>

                <div class="ai-feedback-section">
                    <h2 class="section-title">âœ¨ AI ì†Œë¹„ ë¶„ì„ í”¼ë“œë°±</h2>
                    <p class="section-description">ì›”ë³„ ì§€ì¶œ ë° ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ AIê°€ ë§ì¶¤í˜• ì†Œë¹„ í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
                    
                    <div class="feedback-status">
                        <div id="feedbackLoading" style="display: none; color: #007bff; margin-top: 10px;">ë¶„ì„ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>
                        <div id="feedbackError" style="display: none; color: red; margin-top: 10px;">í”¼ë“œë°±ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>
                    </div>

                    <div class="ai-feedback-output" id="aiFeedbackOutput">
                        <p style="color: #666; margin-top: 20px;">AIê°€ ì†Œë¹„ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ë§ì¶¤í˜• í”¼ë“œë°±ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>
</div>

	<div th:replace="fragments/footer :: footer"></div>

    <script th:inline="javascript">
	    document.querySelectorAll('.stat-card, .category-item').forEach(card => {
	        card.addEventListener('mouseenter', function() {
	            this.style.transform = 'translateY(-10px) scale(1.02)';
	        });
	        
	        card.addEventListener('mouseleave', function() {
	            this.style.transform = 'translateY(0) scale(1)';
	        });
	    });

	    function logout() {
	        if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
	           window.location.href = '/logout';
	        }
	     }
	    const categoryExpenses = /*[[${categoryExpenses}]]*/ [];
	    const labels = [];
	    const data = [];
	    const backgroundColors = [];
	    const colorPalette = [
	        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
	        '#FF9F40', '#E7E9ED', '#C9CBCE', '#A7AEB8', '#868B94',
	        '#6B6B6B', '#FFD700', '#ADFF2F', '#8A2BE2', '#D2691E'
	    ];

	    categoryExpenses.forEach((item, index) => {
	        labels.push(item.categoryName);
	        data.push(Number(item.amount));
	        backgroundColors.push(colorPalette[index % colorPalette.length]);
	    });
		
	    console.log("Labels for Chart:", labels);
	    console.log("Data for Chart (amounts):", data);
	    console.log("Data length:", data.length);
	    console.log("Are all data values zero?", data.every(amount => amount === 0));
		
	    if (data.length === 0 || data.every(amount => amount === 0)) {
	        const chartContainer = document.querySelector('.chart-container');
	        if (chartContainer) {
	            chartContainer.innerHTML = '<p style="text-align:center; padding: 20px; color: #555;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì§€ì¶œì„ ê¸°ë¡í•´ì£¼ì„¸ìš”!</p>';
	            chartContainer.style.display = 'flex';
	            chartContainer.style.alignItems = 'center';
	            chartContainer.style.justifyContent = 'center';
	            chartContainer.style.minHeight = '200px';
	        }
	    } else {
	        const ctx = document.getElementById('categoryChart').getContext('2d');
	        const categoryChart = new Chart(ctx, {
	            type: 'pie',
	            data: {
	                labels: labels,
	                datasets: [{
	                    data: data,
	                    backgroundColor: backgroundColors,
	                    hoverOffset: 4
	                }]
	            },
	            options: {
	                responsive: true,
	                plugins: {
	                    legend: {
	                        position: 'right',
	                    },
	                    tooltip: {
	                        callbacks: {
	                            label: function(context) {
	                                let label = context.label || '';
	                                if (label) {
	                                    label += ': ';
	                                }
	                                const value = context.parsed;
	                                label += 'â‚©' + value.toLocaleString('ko-KR');
	                                return label;
	                            },
	                            afterLabel: function(context) {
	                                const sum = context.dataset.data.reduce((a, b) => a + b, 0);
	                                const currentValue = context.parsed;
	                                const percentage = parseFloat((currentValue / sum * 100).toFixed(1));
	                                return `(${percentage}%)`;
	                            }
	                        }
	                    }
	                }
	            }
	        });
	    }
	    function animateNumbers() {
	        document.querySelectorAll('.stat-number').forEach(element => {
	            const textContent = element.textContent;
	            let number = parseInt(textContent.replace('â‚©', '').replace(/,/g, ''));
	            if (isNaN(number) || number === 0) {
	                return;
	            }
	            let current = 0;
	            const duration = 1000;
	            let startTime = null;
	
	            function easeOutQuad(t) {
	                return t * (2 - t);
	            }
	            function animate(currentTime) {
	                if (!startTime) startTime = currentTime;
	                const progress = (currentTime - startTime) / duration;
	                const easedProgress = easeOutQuad(Math.min(progress, 1));
	                const animatedValue = Math.floor(easedProgress * number);
	                element.textContent = 'â‚©' + animatedValue.toLocaleString('ko-KR');
	
	                if (progress < 1) {
	                    requestAnimationFrame(animate);
	                } else {
	                    element.textContent = textContent;
	                }
	            }
	            requestAnimationFrame(animate);
	        });
	    }
	    window.addEventListener('load', function() {
	        animateNumbers();
	    });
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const markdownTextElement = document.getElementById('categoryAnalysisInsightsHidden');
            if (markdownTextElement) {
                const markdownText = markdownTextElement.textContent;
                const htmlOutput = marked.parse(markdownText);
                const outputElement = document.getElementById('categoryAnalysisOutput');
                if (outputElement) {
                    outputElement.innerHTML = htmlOutput;
                }
            }
            fetchAiFeedback();
        });

        function fetchAiFeedback() {
            const aiFeedbackOutput = document.getElementById('aiFeedbackOutput');
            const feedbackLoading = document.getElementById('feedbackLoading');
            const feedbackError = document.getElementById('feedbackError');

            const csrfHeader = 'X-CSRF-TOKEN';
            let csrfToken = /*[[${_csrf?.token}]]*/ ''; 
            
            if (!csrfToken || csrfToken === '') {
                 const hiddenCsrfInput = document.querySelector('input[name="_csrf"]'); 
                 if (hiddenCsrfInput) {
                     csrfToken = hiddenCsrfInput.value;
                 }
            }
            aiFeedbackOutput.innerHTML = '<p style="color: #666; margin-top: 20px;">AIê°€ ì†Œë¹„ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ë§ì¶¤í˜• í”¼ë“œë°±ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤.</p>';
            feedbackLoading.style.display = 'block'; 
            feedbackError.style.display = 'none';    

            $.ajax({
                url: "/consumption/getChatGptFeedbackForCanalysis",
                type: "GET",
                beforeSend: function(xhr) {
                    if (csrfHeader && csrfHeader !== '' && csrfToken && csrfToken !== '') {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    } else {
                        console.warn("CSRF token or header name is missing. Request might fail.");
                    }
                },
                success: function(response) {
                    feedbackLoading.style.display = 'none';
                    if (response.error) {
                        feedbackError.style.display = 'block'; 
                        aiFeedbackOutput.innerHTML = '<p style="color: red; margin-top: 20px;">ì˜¤ë¥˜: ' + response.error + '</p>';
                    } else if (response.feedback) {
                        aiFeedbackOutput.innerHTML = marked.parse(response.feedback);
                    } else {
                        aiFeedbackOutput.innerHTML = '<p style="color: #666; margin-top: 20px;">AI í”¼ë“œë°±ì„ ë°›ì•„ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                    }
                },
                error: function(xhr, status, error) {
                    feedbackLoading.style.display = 'none'; 
                    feedbackError.style.display = 'block';   
                    console.error("AJAX Error:", status, error, xhr.responseText);
                    aiFeedbackOutput.innerHTML = '<p style="color: red; margin-top: 20px;">í”¼ë“œë°±ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
                }
            });
        }
    </script>
</body>
</html>