<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카테고리 소비분석</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
	<link rel="stylesheet" href="../css/e_feedback.css">
	<link rel="stylesheet" href="../css/common.css">
	
</head>
<body>
<div th:replace="fragments/header :: header"></div>
<div class="app-container">
	
	<!--사이드 메뉴 바-->
<div th:replace="fragments/c_sidebar :: c_sidebar"></div>
<input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">

    <div class="container">
        <div class="analysis-score">
            <div class="score-circle">
                <div class="score-inner">
                    <div class="score-number" id="overallScore" th:text="${efeedbackData.overallScore}">0</div>
                    <div class="score-label">점</div>
                </div>
            </div>
            <div class="score-description" th:text="${efeedbackData.feedbackText}">소비 패턴</div>
            <div class="score-subtitle" th:text="${efeedbackData.efficiencyMessage}">효율성 메시지</div>
        </div>

        <div class="feedback-grid">
            <div class="feedback-card" th:each="feedback : ${efeedbackData.feedbackDetails}">
                <span class="feedback-icon" th:text="${feedback.icon}">💡</span>
                <div class="feedback-title" th:text="${feedback.title}">제목</div>
                <div class="feedback-status" th:classappend="' status-' + ${feedback.statusClass}"
                     th:text="${feedback.status}">상태</div>
                <div class="feedback-content" th:text="${feedback.description}">설명</div>
            </div>
        </div>

        <div class="goal-card">
            <div class="goal-header">
                <div class="goal-title">AI 맞춤형 소비 피드백</div>
                <div class="goal-status status-warning">💡 AI 분석 중</div>
            </div>
            <div class="feedback-content" id="chatGptFeedbackContent">
                <p>AI가 현재 소비 패턴을 분석하여 개인 맞춤 피드백을 생성 중입니다... <span class="loading-spinner"></span></p>
            </div>
        </div>
        <div class="recommendations">
            <h2>맞춤형 개선 제안</h2>
            <div class="recommendation-list">
                <div class="recommendation-item" th:each="rec : ${efeedbackData.recommendations}">
                    <div class="recommendation-title" th:text="${rec.title}"></div>
                    <div class="recommendation-desc" th:text="${rec.description}"></div>
                </div>
            </div>
        </div>

        <div class="progress-section">
            <h2>목표 진행률</h2>
            <div class="progress-grid">
                <div class="progress-item" th:each="prog : ${efeedbackData.progress}">
                    <div class="progress-label">
                        <span>목표</span>
                        <span th:text="${prog.progressText}"></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" th:style="'width: ' + ${prog.progressPercentage} + '%'"></div>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="progressChart"></canvas>
            </div>
            <button class="btn" onclick="generateNewGoals()">새로운 목표 생성하기</button>
        </div>
    </div>
</div>
	<div th:replace="fragments/footer :: footer"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener("DOMContentLoaded", function () {
        animateScore();
        animateProgressBars();
        createProgressChart();
        animateCards();
        
        // ⭐ 페이지 로드 시 ChatGPT 피드백 요청 ⭐
        fetchChatGptFeedback();
    });

    function animateScore() {
        const scoreElement = document.getElementById('overallScore');
        const targetScore = parseInt(scoreElement.innerText, 10);
        if (isNaN(targetScore)) {
            console.warn("overallScore가 유효한 숫자가 아닙니다. 애니메이션을 건너뜀.");
            scoreElement.textContent = "0";
            return;
        }

        let currentScore = 0;
        const increment = targetScore / 50;

        const timer = setInterval(() => {
            currentScore += increment;
            if (currentScore >= targetScore) {
                currentScore = targetScore;
                clearInterval(timer);
            }
            scoreElement.textContent = Math.round(currentScore);
        }, 50);
    }

    function animateProgressBars() {
        const progressBars = document.querySelectorAll('.progress-fill');
        progressBars.forEach((bar, index) => {
            const initialWidth = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.transition = 'width 2s ease-in-out';
                bar.style.width = initialWidth;
            }, 100 + (index * 200));
        });
    }

    function animateCards() {
        const cards = document.querySelectorAll('.feedback-card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';

            setTimeout(() => {
                card.style.transition = 'all 0.6s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 150);
        });
    }

    function createProgressChart() {
        const ctx = document.getElementById('progressChart').getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['1주차', '2주차', '3주차', '4주차'],
                datasets: [{
                    label: '목표 달성률',
                    data: [65, 72, 78, 85],
                    borderColor: '#FFD700',
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#FFB347',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '달성률: ' + context.parsed.y + '%';
                            }
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart'
                }
            }
        });
    }

    function generateNewGoals() {
        const btn = event.target;
        btn.textContent = '목표 생성 중...';
        btn.disabled = true;

        setTimeout(() => {
            alert('새로운 개인 맞춤형 목표가 생성되었습니다!\n\n1. 카페 이용 월 15회로 제한\n2. 온라인 쇼핑 위시리스트 활용\n3. 고정비 5% 절약 도전');
            btn.textContent = '새로운 목표 생성하기';
            btn.disabled = false;

            window.location.href = '/consumption/eanalysis';
        }, 2000);
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ffd700, #ffb347);
            color: #8b4513;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
            z-index: 1000;
            font-weight: bold;
            animation: slideIn 0.3s ease;
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    setInterval(() => {
        const insights = [
            "💡 팁: 이번 주 식비가 예산을 초과했어요!",
            "🎯 목표까지 67,000원 더 절약하면 달성!",
            "📊 지난 달 대비 교통비 15% 절약 중!"
        ];
        const randomInsight = insights[Math.floor(Math.random() * insights.length)];
        showNotification(randomInsight);
    }, 30000); // 30초마다

    // ⭐ ChatGPT 피드백을 가져오는 AJAX 함수 (expense_feedback용) ⭐
    async function fetchChatGptFeedback() {
        const feedbackContentDiv = document.getElementById('chatGptFeedbackContent');
        // 로딩 스피너 표시
        feedbackContentDiv.innerHTML = '<p>AI가 현재 소비 패턴을 분석하여 개인 맞춤 피드백을 생성 중입니다... <span class="loading-spinner"></span></p>';

        try {
            // 새로 만든 API 엔드포인트 호출
            const response = await fetch('/consumption/getChatGptFeedbackForEfeedback');
            const data = await response.json(); // JSON 응답 파싱

            if (data.feedback) {
                // 받은 응답을 div에 삽입
                feedbackContentDiv.innerHTML = '<p>' + data.feedback + '</p>';
                // 상태 텍스트 변경
                const goalStatusDiv = feedbackContentDiv.previousElementSibling.querySelector('.goal-status');
                if (goalStatusDiv) {
                     goalStatusDiv.textContent = '✔️ 분석 완료';
                     goalStatusDiv.classList.remove('status-warning');
                     goalStatusDiv.classList.add('status-success');
                }
            } else if (data.error) {
                feedbackContentDiv.innerHTML = '<p style="color: red;">오류: ' + data.error + '</p>';
                const goalStatusDiv = feedbackContentDiv.previousElementSibling.querySelector('.goal-status');
                if (goalStatusDiv) {
                     goalStatusDiv.textContent = '❌ 오류 발생';
                     goalStatusDiv.classList.remove('status-warning');
                     goalStatusDiv.classList.add('status-danger'); // 새 클래스 추가 필요 시
                }
            } else {
                feedbackContentDiv.innerHTML = '<p>피드백을 가져오는 데 실패했습니다.</p>';
                 const goalStatusDiv = feedbackContentDiv.previousElementSibling.querySelector('.goal-status');
                if (goalStatusDiv) {
                     goalStatusDiv.textContent = '⚠️ 실패';
                     goalStatusDiv.classList.remove('status-warning');
                     goalStatusDiv.classList.add('status-warning');
                }
            }
        } catch (error) {
            console.error('ChatGPT 피드백을 가져오는 중 오류 발생:', error);
            feedbackContentDiv.innerHTML = '<p style="color: red;">피드백 요청 중 네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p>';
            const goalStatusDiv = feedbackContentDiv.previousElementSibling.querySelector('.goal-status');
            if (goalStatusDiv) {
                goalStatusDiv.textContent = '❌ 네트워크 오류';
                goalStatusDiv.classList.remove('status-warning');
                goalStatusDiv.classList.add('status-danger'); // 새 클래스 추가 필요 시
            }
        }
    }
    /*]]>*/
</script>
</body>
</html>