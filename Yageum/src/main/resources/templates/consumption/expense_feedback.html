<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´í…Œê³ ë¦¬ ì†Œë¹„ë¶„ì„</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
	<link rel="stylesheet" href="../css/e_feedback.css">
	<link rel="stylesheet" href="../css/common.css">
	
</head>
<body>
<div th:replace="fragments/header :: header"></div>
<div class="app-container">
	
	<div th:replace="fragments/c_sidebar :: c_sidebar"></div>
<input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">

    <div class="container">
        <div class="analysis-score">
            <div class="score-circle">
                <div class="score-inner">
                    <div class="score-number" id="overallScore" th:text="${efeedbackData.overallScore}">0</div>
                    <div class="score-label">ì </div>
                </div>
            </div>
            <div class="score-description" th:text="${efeedbackData.feedbackText}">ì†Œë¹„ íŒ¨í„´</div>
            <div class="score-subtitle" th:text="${efeedbackData.efficiencyMessage}">íš¨ìœ¨ì„± ë©”ì‹œì§€</div>
        </div>

        <div class="feedback-grid">
            <div class="feedback-card" th:each="feedback : ${efeedbackData.feedbackDetails}">
                <span class="feedback-icon" th:text="${feedback.icon}">ğŸ’¡</span>
                <div class="feedback-title" th:text="${feedback.title}">ì œëª©</div>
                <div class="feedback-status" th:classappend="' status-' + ${feedback.statusClass}"
                     th:text="${feedback.status}">ìƒíƒœ</div>
                <div class="feedback-content" th:text="${feedback.description}">ì„¤ëª…</div>
            </div>
        </div>

        <div class="goal-card">
            <div class="goal-header">
                <div class="goal-title">AI ë§ì¶¤í˜• ì†Œë¹„ í”¼ë“œë°±</div>
                <div class="goal-status status-warning">ğŸ’¡ AI ë¶„ì„ ì¤‘</div>
            </div>
            <div class="feedback-content" id="chatGptFeedbackContent">
                <p>AIê°€ í˜„ì¬ ì†Œë¹„ íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬ ê°œì¸ ë§ì¶¤ í”¼ë“œë°±ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... <span class="loading-spinner"></span></p>
            </div>
        </div>
        <div class="recommendations">
            <h2>ë§ì¶¤í˜• ê°œì„  ì œì•ˆ</h2>
            <div class="recommendation-list">
                <div class="recommendation-item" th:each="rec : ${efeedbackData.recommendations}">
                    <div class="recommendation-title" th:text="${rec.title}"></div>
                    <div class="recommendation-desc" th:text="${rec.description}"></div>
                </div>
            </div>
        </div>

        <div class="progress-section">
            <h2>í˜ë‚´!</h2>
            <div class="progress-grid">
                <div class="progress-item" th:each="prog : ${efeedbackData.progress}">
                    <div class="progress-label">
                        <span>ì ˆì•½ë¥ </span>
                        <span th:text="${prog.progressText}"></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" th:style="'width: ' + ${prog.progressPercentage} + '%'"></div>
                    </div>
                </div>
            </div>
            <button class="btn" onclick="generateNewGoals()">ì „ë°˜ì ìœ¼ë¡œ ë¶„ì„í•˜ê¸°</button>
        </div>
    </div>
</div>
	<div th:replace="fragments/footer :: footer"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // â­ createProgressChart í•¨ìˆ˜ ì •ì˜ ì‹œì‘ â­
    function createProgressChart() {
        // ì´ í•¨ìˆ˜ ë‚´ë¶€ì— ì‹¤ì œ ì°¨íŠ¸ ìƒì„± ë¡œì§ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.
        // ì˜ˆë¥¼ ë“¤ì–´, HTML ë‚´ì˜ <canvas> ìš”ì†Œë¥¼ ì„ íƒí•˜ê³  Chart.jsë¥¼ ì‚¬ìš©í•˜ì—¬ ì°¨íŠ¸ë¥¼ ê·¸ë¦¬ëŠ” ì½”ë“œì…ë‹ˆë‹¤.
        // í˜„ì¬ HTMLì—ëŠ” ì°¨íŠ¸ë¥¼ ê·¸ë¦´ <canvas> ìš”ì†Œê°€ ì—†ìœ¼ë¯€ë¡œ,
        // ë§Œì•½ Chart.jsë¥¼ ì‚¬ìš©í•˜ì—¬ ì°¨íŠ¸ë¥¼ ì‹œê°í™”í•˜ë ¤ë©´
        // <div class="progress-section"> ë‚´ì— <canvas id="myProgressChart"></canvas> ì™€ ê°™ì€ ìš”ì†Œë¥¼ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.
        console.log("createProgressChart í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ í•¨ìˆ˜ ë‚´ë¶€ì— ì°¨íŠ¸ ë¡œì§ì„ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.)");

        // ì˜ˆì‹œ: ê°„ë‹¨í•œ ë¡œê·¸ë§Œ ì¶œë ¥ (ì‹¤ì œ ì°¨íŠ¸ ì½”ë“œë¡œ ëŒ€ì²´ í•„ìš”)
        // ë§Œì•½ íŠ¹ì • IDë¥¼ ê°€ì§„ canvasê°€ ìˆë‹¤ë©´ ì•„ë˜ì™€ ê°™ì´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        // const ctx = document.getElementById('myProgressChart');
        // if (ctx) {
        //     new Chart(ctx, {
        //         type: 'bar', // ë˜ëŠ” 'line', 'pie' ë“± ì›í•˜ëŠ” ì°¨íŠ¸ íƒ€ì…
        //         data: {
        //             labels: ['1ì›”', '2ì›”', '3ì›”'],
        //             datasets: [{
        //                 label: 'ì ˆì•½ë¥ ',
        //                 data: [10, 20, 15], // ì˜ˆì‹œ ë°ì´í„°
        //                 backgroundColor: 'rgba(75, 192, 192, 0.6)'
        //             }]
        //         },
        //         options: {
        //             responsive: true,
        //             maintainAspectRatio: false,
        //             scales: {
        //                 y: {
        //                     beginAtZero: true
        //                 }
        //             }
        //         }
        //     });
        // } else {
        //     console.warn("ì°¨íŠ¸ë¥¼ ê·¸ë¦´ canvas ìš”ì†Œ(myProgressChart)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        // }
    }
    // â­ createProgressChart í•¨ìˆ˜ ì •ì˜ ë â­

    document.addEventListener("DOMContentLoaded", function () {
        animateScore();
        animateProgressBars();
        createProgressChart(); // ì´ì œ createProgressChart í•¨ìˆ˜ê°€ ì •ì˜ë˜ì–´ ìˆì–´ ReferenceErrorê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        animateCards();
        
        // â­ í˜ì´ì§€ ë¡œë“œ ì‹œ ChatGPT í”¼ë“œë°± ìš”ì²­ â­
        fetchChatGptFeedback();
    });

    function animateScore() {
        const scoreElement = document.getElementById('overallScore');
        const targetScore = parseInt(scoreElement.innerText, 10);
        if (isNaN(targetScore)) {
            console.warn("overallScoreê°€ ìœ íš¨í•œ ìˆ«ìê°€ ì•„ë‹™ë‹ˆë‹¤. ì• ë‹ˆë©”ì´ì…˜ì„ ê±´ë„ˆëœ€.");
            scoreElement.textContent = "0";
            return;
        }

        let currentScore = 0;
        const increment = targetScore / 50;

        const timer = setInterval(() => {
            currentScore += increment;
            if (currentScore >= targetScore) {
                currentScore = targetScore;
                clearInterval(timer);
            }
            scoreElement.textContent = Math.round(currentScore);
        }, 50);
    }

    function animateProgressBars() {
        const progressBars = document.querySelectorAll('.progress-fill');
        progressBars.forEach((bar, index) => {
            const initialWidth = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.transition = 'width 2s ease-in-out';
                bar.style.width = initialWidth;
            }, 100 + (index * 200));
        });
    }

    function animateCards() {
        const cards = document.querySelectorAll('.feedback-card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';

            setTimeout(() => {
                card.style.transition = 'all 0.6s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 150);
        });
    }

    function generateNewGoals() {
        const btn = event.target;
        btn.textContent = 'ì „ë°˜ì ì¸ ë¶„ì„ ì¤‘...';
        btn.disabled = true;

        setTimeout(() => {
            alert('ìƒˆë¡œìš´ ê°œì¸ ë§ì¶¤í˜• ëª©í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n1. ì¹´í˜ ì´ìš© ì›” 15íšŒë¡œ ì œí•œ\n2. ì˜¨ë¼ì¸ ì‡¼í•‘ ìœ„ì‹œë¦¬ìŠ¤íŠ¸ í™œìš©\n3. ê³ ì •ë¹„ 5% ì ˆì•½ ë„ì „');
            btn.textContent = 'ì „ë°˜ì ìœ¼ë¡œ ë¶„ì„í•˜ê¸°';
            btn.disabled = false;

            window.location.href = '/consumption/eanalysis';
        }, 2000);
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ffd700, #ffb347);
            color: #8b4513;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
            z-index: 1000;
            font-weight: bold;
            animation: slideIn 0.3s ease;
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    setInterval(() => {
        const insights = [
            "ğŸ’¡ íŒ: ì´ë²ˆ ì£¼ ì‹ë¹„ê°€ ì˜ˆì‚°ì„ ì´ˆê³¼í–ˆì–´ìš”!",
            "ğŸ¯ ëª©í‘œê¹Œì§€ 67,000ì› ë” ì ˆì•½í•˜ë©´ ë‹¬ì„±!",
            "ğŸ“Š ì§€ë‚œ ë‹¬ ëŒ€ë¹„ êµí†µë¹„ 15% ì ˆì•½ ì¤‘!"
        ];
        const randomInsight = insights[Math.floor(Math.random() * insights.length)];
        showNotification(randomInsight);
    }, 30000); // 30ì´ˆë§ˆë‹¤

    // â­ ChatGPT í”¼ë“œë°±ì„ ê°€ì ¸ì˜¤ëŠ” AJAX í•¨ìˆ˜ (expense_feedbackìš©) â­
    async function fetchChatGptFeedback() {
        const feedbackContentDiv = document.getElementById('chatGptFeedbackContent');
        // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
        feedbackContentDiv.innerHTML = '<p>AIê°€ í˜„ì¬ ì†Œë¹„ íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬ ê°œì¸ ë§ì¶¤ í”¼ë“œë°±ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... <span class="loading-spinner"></span></p>';

        try {
            // ìƒˆë¡œ ë§Œë“  API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
            const response = await fetch('/consumption/getChatGptFeedbackForEfeedback');
            const data = await response.json(); // JSON ì‘ë‹µ íŒŒì‹±

            if (data.feedback) {
                // ë°›ì€ ì‘ë‹µì„ divì— ì‚½ì…
                feedbackContentDiv.innerHTML = '<p>' + data.feedback + '</p>';
                // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€ê²½
                const goalStatusDiv = feedbackContentDiv.previousElementSibling.querySelector('.goal-status');
                if (goalStatusDiv) {
                     goalStatusDiv.textContent = 'âœ”ï¸ ë¶„ì„ ì™„ë£Œ';
                     goalStatusDiv.classList.remove('status-warning');
                     goalStatusDiv.classList.add('status-success');
                }
            } else if (data.error) {
                feedbackContentDiv.innerHTML = '<p style="color: red;">ì˜¤ë¥˜: ' + data.error + '</p>';
                const goalStatusDiv = feedbackContentDiv.previousElementSibling.querySelector('.goal-status');
                if (goalStatusDiv) {
                     goalStatusDiv.textContent = 'âŒ ì˜¤ë¥˜ ë°œìƒ';
                     goalStatusDiv.classList.remove('status-warning');
                     goalStatusDiv.classList.add('status-danger'); // ìƒˆ í´ë˜ìŠ¤ ì¶”ê°€ í•„ìš” ì‹œ
                }
            } else {
                feedbackContentDiv.innerHTML = '<p>í”¼ë“œë°±ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
                 const goalStatusDiv = feedbackContentDiv.previousElementSibling.querySelector('.goal-status');
                if (goalStatusDiv) {
                     goalStatusDiv.textContent = 'âš ï¸ ì‹¤íŒ¨';
                     goalStatusDiv.classList.remove('status-warning');
                     goalStatusDiv.classList.add('status-warning');
                }
            }
        } catch (error) {
            console.error('ChatGPT í”¼ë“œë°±ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            feedbackContentDiv.innerHTML = '<p style="color: red;">í”¼ë“œë°± ìš”ì²­ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
            const goalStatusDiv = feedbackContentDiv.previousElementSibling.querySelector('.goal-status');
            if (goalStatusDiv) {
                goalStatusDiv.textContent = 'âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜';
                goalStatusDiv.classList.remove('status-warning');
                goalStatusDiv.classList.add('status-danger'); // ìƒˆ í´ë˜ìŠ¤ ì¶”ê°€ í•„ìš” ì‹œ
            }
        }
    }
    /*]]>*/
</script>
</body>
</html>