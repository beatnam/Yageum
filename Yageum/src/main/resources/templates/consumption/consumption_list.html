<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>종합 분석 피드백 리스트</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/consumption_list.css">
</head>
<body>
<div th:replace="fragments/header :: header"></div>
<div class="app-container">
    <div th:replace="fragments/sidebar :: sidebar"></div>
    <div class="main-wrapper">
        <div class="container">
            <div class="header_list">
                <h1>소비 분석 피드백 히스토리</h1>
                <p>저장된 개인 소비 패턴 분석 피드백을 확인하세요.</p>
            </div>

            <div class="feedback-list-section" id="feedbackListContainer">
                </div>
        </div></div> </div>

<div th:replace="fragments/footer :: footer"></div>

<script th:inline="javascript">
    const feedbackData = /*[[${feedbackList}]]*/ '[]';
    const feedbackListContainer = document.getElementById('feedbackListContainer');

    if (feedbackData && Array.isArray(feedbackData)) {
        feedbackData.forEach((data, index) => {
            let conMonthDate;
            if (data.conMonth) {
                conMonthDate = new Date(data.conMonth);
                if (isNaN(conMonthDate.getTime())) {
                    console.warn("Invalid conMonth date received:", data.conMonth);
                    conMonthDate = new Date();
                }
            } else {
                conMonthDate = new Date();
                console.warn("conMonth field is missing for feedback data:", data);
            }

            const year = conMonthDate.getFullYear();
            const month = conMonthDate.getMonth() + 1;
            const formattedMonth = `${year}년 ${month}월`;

            const lastDay = new Date(year, month, 0).getDate();
            const formattedDateRange = `${year}.${String(month).padStart(2, '0')}.01 ~ ${year}.${String(month).padStart(2, '0')}.${String(lastDay).padStart(2, '0')}`;

            const conTotalValue = parseFloat(data.conTotal) || 0;
            const conTotalFormatted = new Intl.NumberFormat('ko-KR').format(conTotalValue);

            const feedbackItem = document.createElement('div');
            feedbackItem.classList.add('feedback-item');

            feedbackItem.innerHTML = `
                <div class="feedback-header">
                    <div class="feedback-info">
                        <div class="feedback-title">${formattedMonth} 지출 분석 피드백</div>
                        <div class="feedback-meta">
                            <span>기간: ${formattedDateRange}</span>
                            <span>총 지출 금액: ₩${conTotalFormatted}</span>
                        </div>
                    </div>
                    <div class="feedback-actions">
                        <button class="view-button" onclick="toggleFeedback(this, 'feedbackContent-${data.conIn}', ${month}, ${year})">종합분석 피드백 보기</button>
                        <button class="delete-button" onclick="deleteFeedbackItem(this, ${data.conIn})">삭제</button>
                    </div>
                </div>
                <div class="feedback-content" id="feedbackContent-${data.conIn}">
                    <canvas id="chart-${data.conIn}"></canvas>
                    <p>${data.conResult || '피드백 내용이 없습니다.'}</p>
                </div>
            `;
            feedbackListContainer.appendChild(feedbackItem);
        });
    } else {
        console.warn("feedbackList 데이터를 찾을 수 없거나 유효한 배열이 아닙니다.");
        feedbackListContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 50px;">아직 등록된 소비 분석 피드백이 없습니다.</p>';
    }

    // ⭐ toggleFeedback 함수 수정: 월, 년도 파라미터 추가 및 AJAX 호출 ⭐
    function toggleFeedback(button, contentId, month, year) {
        const content = document.getElementById(contentId);
        const chartCanvas = document.getElementById(`chart-${contentId.split('-')[1]}`); // chart-${conIn} 에서 conIn 추출
        const chartId = `chart-${contentId.split('-')[1]}`;
        const feedbackConIn = contentId.split('-')[1]; // conIn 값

        content.classList.toggle('show');

        if (content.classList.contains('show')) {
            button.textContent = '피드백 숨기기';
            // ⭐ 피드백 내용이 펼쳐질 때만 차트 데이터를 AJAX로 가져와서 그립니다. ⭐
            // 차트가 이미 그려져 있는지 확인하여 중복 로딩 방지 (선택 사항)
            if (!chartCanvas.dataset.chartLoaded) { // data-chart-loaded 속성을 사용하여 로딩 여부 확인
                fetchCategoryExpenses(feedbackConIn, month, year);
                chartCanvas.dataset.chartLoaded = true; // 차트 로드 플래그 설정
            }
        } else {
            button.textContent = '종합분석 피드백 보기';
        }
    }

    // ⭐ 새로 추가할 AJAX 함수 ⭐
    function fetchCategoryExpenses(conIn, month, year) {
        const chartCanvas = document.getElementById(`chart-${conIn}`);
        const noDataMessageId = `no-chart-data-${conIn}`;
        let noDataMessageElement = document.getElementById(noDataMessageId);

        // 이전 차트나 메시지 제거 (갱신 시 필요)
        if (chartCanvas && chartCanvas.chart) { // Chart.js 인스턴스가 있다면 파괴
            chartCanvas.chart.destroy();
            chartCanvas.chart = null;
        }
        if (noDataMessageElement) {
            noDataMessageElement.remove();
        }
        chartCanvas.style.display = 'block'; // 캔버스 다시 보이게 설정

        const token = $("meta[name='_csrf']").attr("content");
        const header = $("meta[name='_csrf_header']").attr("content");

        $.ajax({
            url: `/consumption/categoryExpenses?month=${month}&year=${year}`,
            type: 'GET',
            dataType: 'json',
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success: function(categoriesData) {
                if (Object.keys(categoriesData).length > 0) {
                    const ctx = chartCanvas.getContext('2d');
                    // Chart.js 인스턴스를 canvas 객체에 저장하여 나중에 참조
                    chartCanvas.chart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(categoriesData),
                            datasets: [{
                                data: Object.values(categoriesData),
                                backgroundColor: [
                                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#E7E9ED', '#8AC926', '#FFCA3A'
                                ],
                                hoverOffset: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            aspectRatio: 1,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    maintainAspectRatio: false,
                                    labels: {
                                        boxWidth: 20,
                                    }
                                },
                                title: {
                                    display: true,
                                    text: `${year}년 ${month}월 카테고리별 지출`,
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    },
                                    color: '#34495e'
                                }
                            },
                            tooltips: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(context.parsed);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    });
                } else {
                    console.warn(`No category data available for conIn: ${conIn} (month: ${month}, year: ${year}). Chart will not be displayed.`);
                    chartCanvas.style.display = 'none';
                    const noDataMessage = document.createElement('p');
                    noDataMessage.id = noDataMessageId;
                    noDataMessage.textContent = '카테고리별 지출 데이터가 없습니다.';
                    noDataMessage.style.textAlign = 'center';
                    noDataMessage.style.color = '#7f8c8d';
                    chartCanvas.parentNode.insertBefore(noDataMessage, chartCanvas.nextSibling);
                }
            },
            error: function(xhr, status, error) {
                console.error("Failed to fetch category expenses:", error);
                chartCanvas.style.display = 'none';
                const noDataMessage = document.createElement('p');
                noDataMessage.id = noDataMessageId;
                noDataMessage.textContent = '카테고리 데이터를 불러오는데 실패했습니다.';
                noDataMessage.style.textAlign = 'center';
                noDataMessage.style.color = '#e74c3c';
                chartCanvas.parentNode.insertBefore(noDataMessage, chartCanvas.nextSibling);
            }
        });
    }

    function deleteFeedbackItem(button, conInId) {
        if (confirm('이 피드백을 삭제하시겠습니까?')) {
            const token = $("meta[name='_csrf']").attr("content");
            const header = $("meta[name='_csrf_header']").attr("content");

            $.ajax({
                url: '/consumption/feedback/' + conInId,
                type: 'DELETE',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success: function(result) {
                    const itemToRemove = button.closest('.feedback-item');
                    itemToRemove.remove();
                    alert('피드백이 성공적으로 삭제되었습니다.');
                },
                error: function(xhr, status, error) {
                    alert('피드백 삭제에 실패했습니다: ' + error);
                    console.error("삭제 실패:", xhr.responseText);
                }
            });
        }
    }
</script>
</body>
</html>